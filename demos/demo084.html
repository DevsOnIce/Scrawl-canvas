<!DOCTYPE html>
<html>
	<head>
		<title>Demo 084</title>
		<link href="css/normalize.css" rel="stylesheet" />
		<link href="css/demo.css" rel="stylesheet" />
	</head>
	<body>
		<h1><a href="index.html">Scrawl.js</a> - demonstration 084</h1>
		<h2>Scrawl.js image tile puzzle</h2>
		<h3>Modules: block, shape, animation, images, collisions</h3>
		<p id="myP">Mixing tiles ...</p>
		<img src="img/gun.png" id="gun" class="demo084" />
		<canvas id="mycanvas" width="400" height="400"></canvas>
		<p id="testmessage"></p>
		<script src="../source/scrawlCore.js"></script>
		<script>
			var mycode = function(){
				'use strict'
				var testTicker = Date.now(),
					testTime = testTicker,
					testNow,
					testMessage = document.getElementById('testmessage');
					
				//define variables
				var myCanvas = scrawl.canvas.mycanvas,
					myPad = scrawl.pad.mycanvas,
					selectedTile = false, 
					previousTile = false, 
					moving = false,
					prepare = true,
					mixCounter = 0, 
					here, 
					currentTile, 
					legalTiles,
					myTiles,
					myTile,
					mySpace,
					spaceBlock,
					getLegalTiles,
					spaceTileMove,
					myX, 
					myY,
					hit,
					mySprite,
					startTileMove,
					endTileMove,
					mixTiles,
					handleSprite;
				
				//import images into scrawl library
				scrawl.getImagesByClass('demo084');
				
				//define groups
				myTiles = scrawl.newGroup({
					name: 	'tiles',
					order: 	1,
					});
				mySpace = scrawl.newGroup({
					name: 	'space',
					order: 	3,
					});
				scrawl.newGroup({
					name: 	'lines',
					order: 	2,
					});
					
				//define sprites
				myTile = scrawl.newPicture({
					source: 		'gun',
					group: 			'tiles',
					width: 			80,
					height: 		80,
					copyWidth: 		80,
					copyHeight: 	80,
					handleX: 		'center',
					handleY: 		'center',
					delta: 			{}
					});
				for(var i = 0; i < 5; i++){
					for(var j = 0; j < 5; j++){
						myTile.clone({
							name: 		'tile'+i+''+j,
							copyX: 		i * 80,
							startX: 	i * 80 + 40,
							copyY: 		j * 80,
							startY: 	j * 80 + 40,
							keepCopyDimensions: true,
							});
						}
					}
				scrawl.deleteSprite([myTile.name, 'tile44']);
				
				scrawl.newShape({
					strokeStyle:	'white',
					lineWidth:		2,
					group: 			'lines',
					data: 			'm0,79 400,0m0,80-400,0m0,80 400,0m0,80-400,0m80,80 0-400m80,0 0,400m80,0 0-400m80,0 0,400',
					});
				
				spaceBlock = scrawl.newBlock({
					name: 				'spacer',
					startX: 			360,
					startY: 			360,
					handleX: 			'center',
					handleY: 			'center',
					width: 				100,
					height: 			100,
					fillStyle: 			'rgba(0,0,0,0)',
					strokeStyle: 		'red',
					lineWidth: 			4,
					method: 			'fillDraw',
					group: 				'space',
					collisionPoints: 	'edges',
					});
					
				//animation functions
				getLegalTiles = function(){						//get tiles next to the mySpace tile
					legalTiles = [];
					hit = mySpace.getBetweenGroupSpriteHits(myTiles);
					for(var i = 0, z = hit.length; i < z; i++){
						scrawl.pushUnique(legalTiles, hit[i][1]);
						}
					};
					
				startTileMove = function(hit){					//initialise a tile to move
					if(scrawl.xt(hit)){
						myX = 0, myY = 0;
						if(hit.start.x !== spaceBlock.start.x){
							(hit.start.x < spaceBlock.start.x) ? myX = 2 : myX = -2;
							}
						else{
							(hit.start.y < spaceBlock.start.y) ? myY = 2 : myY = -2;
							}
						hit.delta.set({
							x: myX,
							y: myY,
							});
						currentTile = hit;
						moving = true;
						}
					};
					
				endTileMove = function(){						//tidy up after tile move completed
					myX = 0, myY = 0;
					if(currentTile.delta.x !== 0){
						myX = (currentTile.delta.x < 0) ? 80 : -80;
						}
					else{
						myY = (currentTile.delta.y < 0) ? 80 : -80;
						}
					spaceBlock.setDelta({
						start: {
							x: myX,
							y: myY,
							}
						});
					currentTile.delta.set();
					moving = false;
					};
					
				mixTiles = function(){							//mixing up the tiles
					if(!moving){
						getLegalTiles();
						if(selectedTile){
							scrawl.removeItem(legalTiles, previousTile);
							scrawl.removeItem(legalTiles, selectedTile);
							}
						previousTile = selectedTile;
						selectedTile = legalTiles[Math.floor(Math.random() * legalTiles.length)]
						startTileMove(scrawl.sprite[selectedTile]);
						mixCounter++;
						if(mixCounter >= 25){
							prepare = false;
							document.getElementById('myP').innerHTML = 'Click on tile to move it into the adjacent space'
							}
						}
					};
					
				//event handler
				handleSprite = function(e){
					if(e){
						e.stopPropagation();
						e.preventDefault();
						}
					if(!prepare){
						if(!moving){
							mySprite = myTiles.getSpriteAt(here);
							if(mySprite){
								getLegalTiles();
								if(scrawl.contains(legalTiles, mySprite.name)){
									startTileMove(mySprite);
									}
								}
							}
						}
					};
				myCanvas.addEventListener('mouseup', handleSprite, false);
				
				//animation object
				scrawl.newAnimation({
					fn: function(){
						here = myPad.getMouse();
						if(prepare){
							mixTiles();
							}
						if(moving && currentTile){
							currentTile.updateStart();
							if(currentTile.start.isEqual(spaceBlock.start)){
								endTileMove();
								}
							}
						scrawl.render();
						
						testNow = Date.now();
						testTime =  testNow - testTicker;
						testTicker = testNow;
						testMessage.innerHTML = 'Milliseconds per screen refresh: '+parseInt(testTime)+'; fps: '+parseInt(1000/testTime);
						},
					});
				};
				
			scrawl.loadModules({
				path: '../source/js/',
				minified: false,
				modules: ['block', 'shape', 'animation', 'images', 'collisions'],
				callback: function(){
					window.addEventListener('load', function(){
						scrawl.init();
						mycode();
						};
					},
				});
		</script>
    </body>
</html>
