<!DOCTYPE html>
<html>

<head>
  <title>Demo 305</title>
  <link href="css/normalize.css" rel="stylesheet" />
  <link href="css/demo.css" rel="stylesheet" />
</head>

<body>
  <h1><a href="index.html">Scrawl.js</a> - demonstration 305</h1>
  <h2>Physics engine - cloth in wind</h2>
  <h3>Modules: physics, animation</h3>
  <p id="msg1"></p>
  <p id="msg2"></p>
  <p id="msg3"></p>
  <canvas id="mycanvas" width="600" height="600"></canvas>
  <script src="../source/scrawlCore.js"></script>
  <script id="myscript">
    var mycode = function() {
      'use strict'
      var msg1 = document.getElementById('msg1');
      var msg2 = document.getElementById('msg2');
      var msg3 = document.getElementById('msg3');

      //define variables
      var pad = scrawl.pad.mycanvas,
        ctx = scrawl.context[pad.base],
        ticker = Date.now(),
        dTime = 0,
        sTime = 0,
        maxTime = 20,
        now,
        rows = 20,
        cols = 20,
        holeW = 10,
        holeH = 10,
        windXMax = 12,
        windXMin = -1,
        windXDelta = 0.01,
        windYMax = -0.6,
        windYMin = -0.15,
        windYDelta = -0.003,
        calculatePositions,
        updateWind,
        drawNet;

      //define physics - forces
      scrawl.physics.windSpeedX = 3;
      scrawl.physics.windSpeedY = -0.2;
      scrawl.newForce({
        name: 'wind',
        fn: function(ball) {
          // constant = 0.5 * 1.23 [default airDensity] * 6.428 [half surface area of 1m radius sphere] * 0.42 [default drag]
          var constant = 1.6603524,
            wx = scrawl.physics.windSpeedX,
            wy = scrawl.physics.windSpeedY,
            wind = scrawl.v.set({ //generic work vector
              x: constant * wx * wx,
              y: constant * wy * wy,
            });
          ball.load.vectorAdd(wind);
        },
      });

      //define physics - particles
      for (var i = 0; i < rows; i++) {
        for (var j = 0; j < cols; j++) {
          scrawl.newParticle({
            name: 'b_' + i + '_' + j,
            startX: 200.5 + (i * holeW),
            startY: 150.5 + (j * holeH),
            mass: 2,
            radius: 1,
          }).addForce('gravity').addForce('wind');
        }
      }

      scrawl.sprite.b_0_0.set({
        mobile: false,
      });
      scrawl.sprite['b_0_' + (cols - 1)].set({
        mobile: false,
      });

      //define physics - springs
      for (var i = 0; i < rows; i++) {
        for (var j = 0; j < cols; j++) {
          if (i < (rows - 1)) {
            scrawl.sprite['b_' + i + '_' + j].addSpring({
              name: 's_' + i + '_' + j + '_across',
              end: 'b_' + (i + 1) + '_' + j,
              springConstant: 1000,
              damperConstant: 10,
            });
          }
          if (j < (cols - 1)) {
            scrawl.sprite['b_' + i + '_' + j].addSpring({
              name: 's_' + i + '_' + j + '_down',
              end: 'b_' + i + '_' + (j + 1),
              springConstant: 1000,
              damperConstant: 10,
            });
          }
        }
      }

      //physics update functions
      calculatePositions = function() {
        now = Date.now();
        sTime = now - ticker;
        ticker = now;
        dTime = (sTime > maxTime) ? maxTime : sTime;
        scrawl.physics.deltaTime = dTime / 1000;
        scrawl.updateSprings();
      };

      updateWind = function() {
        var ws = scrawl.physics.windSpeedX + windXDelta;
        if (ws > windXMax || ws < windXMin) {
          windXDelta = -windXDelta;
        }
        ws = scrawl.physics.windSpeedY + windYDelta;
        if (ws > windYMax || ws < windYMin) {
          windYDelta = -windYDelta;
        }
        scrawl.physics.windSpeedX += windXDelta;
        scrawl.physics.windSpeedY += windYDelta;
      }

      //drawing function
      drawNet = function() {
        var mySpring,
          pt1,
          pt2;
        pad.clear();
        pad.compile(); //particle positioning is computed as part of the compile() process
        ctx.beginPath();
        for (var i = 0, z = scrawl.springnames.length; i < z; i++) {
          mySpring = scrawl.spring[scrawl.springnames[i]];
          pt1 = scrawl.sprite[mySpring.start].place;
          pt2 = scrawl.sprite[mySpring.end].place;
          ctx.moveTo(pt1.x, pt1.y);
          ctx.lineTo(pt2.x, pt2.y);
        }
        ctx.stroke();
        pad.show();
      };

      //animation object
      scrawl.newAnimation({
        fn: function() {
          updateWind();
          calculatePositions();
          drawNet();

          msg1.innerHTML = 'Milliseconds per physics refresh: ' + parseInt(dTime);
          msg2.innerHTML = 'Milliseconds per screen refresh: ' + parseInt(sTime);
          msg3.innerHTML = 'Frames per second: ' + parseInt(1000 / sTime);
        },
      });
    };

    scrawl.loadModules({
        path: '../source/js/',
        minified: false,
        modules: ['physics', 'animation'],
        callback: function() {
          window.addEventListener('load', function() {
              scrawl.init();
              mycode();
            };
          },
        });
  </script>
</body>

</html>
