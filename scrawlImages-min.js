/*! scrawl 2014-04-05 */
"use strict";var scrawl=function(a){return a.getImagesByClass=function(b){if(b){var c=[],d=document.getElementsByClassName(b);if(d.length>0){for(var e=0,f=d.length;f>e;e++){var g=a.newImage({element:d[e]});c.push(g.name)}return c}}return console.log('my.getImagesByClass() failed to find any <img> elements of class="'+b+'" on the page'),!1},a.newPattern=function(b){return new a.Pattern(b)},a.newPicture=function(b){return new a.Picture(b)},a.newImage=function(b){return new a.ScrawlImage(b)},a.newAnimSheet=function(b){return new a.AnimSheet(b)},a.pushUnique(a.sectionlist,"image"),a.pushUnique(a.sectionlist,"img"),a.pushUnique(a.nameslist,"imagenames"),a.pushUnique(a.nameslist,"animnames"),a.pushUnique(a.sectionlist,"anim"),a.Pattern=function(b){return b=a.safeObject(b),a.Base.call(this,b),a.Base.prototype.set.call(this,b),this.repeat=b.repeat||"repeat",this.cell=b.cell||a.pad[a.currentPad].current,this.setImage(b.source||b.imageData||a.image[b.image]||a.cell[b.canvas]||!1,b.callback),this},a.Pattern.prototype=Object.create(a.Base.prototype),a.Pattern.prototype.type="Pattern",a.Pattern.prototype.classname="designnames",a.d.Pattern={repeat:"repeat",cell:"",image:"",source:"",canvas:""},a.mergeInto(a.d.Pattern,a.d.Base),a.Pattern.prototype.set=function(b){return a.Base.prototype.set.call(this,b),this.setImage(),this},a.Pattern.prototype.setImage=function(b,c){if(a.isa(b,"str")){var d=new Image,e=this;d.id=this.name,d.onload=function(b){try{var c=a.newImage({name:e.name,element:d});a.design[e.name]=e,a.design[e.name].image=c.name,a.design[e.name].source=d.src,a.pushUnique(a.designnames,e.name),a.design[e.name].makeDesign(),a.isa(b,"fn")&&b()}catch(f){return console.log("Pattern "+[e.name]+" - setImage() #1 failed - "+f.name+" error: "+f.message),e}},d.src=b}else if(a.isa(b,"obj")){if("ScrawlImage"===b.type)try{this.image=b.name,a.design[this.name]=this,a.pushUnique(a.designnames,this.name),this.makeDesign(),a.isa(c,"fn")&&c()}catch(f){return console.log("Pattern "+[this.name]+" - setImage() #2 failed - "+f.name+" error: "+f.message),e}else if("Cell"===b.type)try{this.canvas=b.name,a.design[this.name]=this,a.pushUnique(a.designnames,this.name),this.makeDesign(),a.isa(c,"fn")&&c()}catch(f){return console.log("Pattern "+[this.name]+" - setImage() #3 failed - "+f.name+" error: "+f.message),e}}else console.log("Pattern "+[this.name]+" - setImage() #4 failed - source not a string or an object",b);return this},a.Pattern.prototype.getData=function(){return a.xt(a.dsn[this.name])?a.dsn[this.name]:"rgba(0,0,0,0)"},a.Pattern.prototype.makeDesign=function(){var b=a.context[this.cell],c=a.xt(a.img[this.image])?a.img[this.image]:a.object[this.image];return this.image?c&&(a.dsn[this.name]=b.createPattern(c,this.repeat)):this.canvas&&(a.dsn[this.name]=b.createPattern(a.canvas[this.canvas],this.repeat)),this},a.Pattern.prototype.remove=function(){return delete a.dsn[this.name],delete a.design[this.name],a.removeItem(a.designnames,this.name),!0},a.Pattern.prototype.update=function(){return this.makeDesign(),this},a.Picture=function(b){if(a.isa(b,"obj")&&a.xt(b.url))return this.importImage(b);b=a.safeObject(b),a.Sprite.call(this,b),a.Position.prototype.set.call(this,b);var c,d,e,f,g;return this.source=b.source||!1,this.imageType=this.sourceImage(b.source)||!1,this.source&&("img"===this.imageType?(c=a.image[this.source],d=c.get("width"),e=c.get("height"),f=0,g=0):"canvas"===this.imageType?(c=a.cell[this.source],d=c.sourceWidth,e=c.sourceHeight,f=c.source.x,g=c.source.y):"animation"===this.imageType&&(c=a.anim[this.get("animSheet")].getData(),d=c.copyWidth,e=c.copyHeight,f=c.copyX,g=c.copyY),this.width=b.width||d,this.height=b.height||e,this.copyX=b.copyX||f,this.copyY=b.copyY||g,this.copyWidth=b.copyWidth||d,this.copyHeight=b.copyHeight||e),this.registerInLibrary(),a.pushUnique(a.group[this.group].sprites,this.name),this},a.Picture.prototype=Object.create(a.Sprite.prototype),a.Picture.prototype.type="Picture",a.Picture.prototype.classname="spritenames",a.d.Picture={source:"",imageData:"",imageDataChannel:"alpha",animSheet:"",imageType:"",checkHitUsingImageData:!1,copyX:0,copyY:0,copyWidth:0,copyHeight:0},a.mergeInto(a.d.Picture,a.d.Sprite),a.Picture.prototype.get=function(b){return a.contains(a.animKeys,b)?a.anim[this.animSheet].get(b):a.Sprite.prototype.get.call(this,b)},a.Picture.prototype.set=function(b){return a.Sprite.prototype.set.call(this,b),a.xt(this.animSheet)&&a.anim[this.animSheet].set(b),b=a.safeObject(b),this.width=b.width||this.width,this.height=b.height||this.height,this.copyX=b.copyX||this.copyX,this.copyY=b.copyY||this.copyY,this.copyWidth=b.copyWidth||this.copyWidth,this.copyHeight=b.copyHeight||this.copyHeight,this},a.Picture.prototype.setDelta=function(b){return a.Sprite.prototype.setDelta.call(this,b),b=a.safeObject(b),a.xt(b.width)&&(this.width+=b.width),a.xt(b.height)&&(this.height+=b.height),a.xt(b.copyX)&&(this.copyX+=b.copyX),a.xt(b.copyY)&&(this.copyY+=b.copyY),a.xt(b.copyWidth)&&(this.copyWidth+=b.copyWidth),a.xt(b.copyHeight)&&(this.copyHeight+=b.copyHeight),this},a.Picture.prototype.importImage=function(b){if(!a.isa(b,"obj")||!a.xt(b.url))return console.log("Picture.importImage() failed - no url supplied"),!1;var c=new Image;c.id=b.name||"image"+Math.floor(1e8*Math.random()),c.crossOrigin="anonymous",c.onload=function(){a.newImage({name:c.id,element:c});delete b.url,b.source=c.id;var d=a.newPicture(b);return a.isa(b.callback,"fn")&&b.callback.call(d),d},c.onerror=function(){return console.log("Picture.importImage() failed - <"+c.id+"> failed to load"),!1},c.src=b.url},a.Picture.prototype.clone=function(b){var c=a.Sprite.prototype.clone.call(this,b);return b=a.safeObject(b),b.keepCopyDimensions||c.fitToImageSize(),c},a.Picture.prototype.fitToImageSize=function(){if("img"===this.imageType){var b=a.image[this.source];this.set({copyWidth:b.get("width"),copyHeight:b.get("height"),copyX:0,copyY:0})}return this},a.Picture.prototype.sourceImage=function(){return this.get("animSheet")&&a.contains(a.imagenames,this.source)?"animation":a.contains(a.imagenames,this.source)?"img":a.contains(a.cellnames,this.source)?"canvas":!1},a.Picture.prototype.clip=function(a){var b=this.prepareStamp();return a.save(),this.rotateCell(a),a.beginPath(),a.rect(b.x,b.y,this.width*this.scale,this.height*this.scale),a.clip(),this},a.Picture.prototype.clear=function(a){var b=this.prepareStamp();return this.rotateCell(a),a.clearRect(b.x,b.y,this.width*this.scale,this.height*this.scale),this},a.Picture.prototype.clearWithBackground=function(b,c){var d=this.prepareStamp(),e=this.width*this.scale,f=this.height*this.scale;return this.rotateCell(b),b.fillStyle=a.cell[c].backgroundColor,b.strokeStyle=a.cell[c].backgroundColor,b.globalAlpha=1,b.strokeRect(d.x,d.y,e,f),b.fillRect(d.x,d.y,e,f),b.fillStyle=a.ctx[c].fillStyle,b.strokeStyle=a.ctx[c].strokeStyle,b.globalAlpha=a.ctx[c].globalAlpha,this},a.Picture.prototype.draw=function(b,c){var d=this.prepareStamp();return this.rotateCell(b),a.cell[c].setEngine(this),b.strokeRect(d.x,d.y,this.width*this.scale,this.height*this.scale),this},a.Picture.prototype.fill=function(b,c){var d;if(this.imageType){d=this.prepareStamp(),this.rotateCell(b),a.cell[c].setEngine(this);try{b.drawImage(this.getImage(),this.copyX,this.copyY,this.copyWidth,this.copyHeight,d.x,d.y,this.width*this.scale,this.height*this.scale)}catch(e){console.log("Picture "+this.name+' experienced a "fill" drawImage glitch')}}return this},a.Picture.prototype.drawFill=function(b,c){var d,e,f;if(this.imageType){d=this.prepareStamp(),e=this.width*this.scale,f=this.height*this.scale,this.rotateCell(b),a.cell[c].setEngine(this),b.strokeRect(d.x,d.y,e,f),this.clearShadow(b,c);try{b.drawImage(this.getImage(),this.copyX,this.copyY,this.copyWidth,this.copyHeight,d.x,d.y,e,f)}catch(g){console.log("Picture "+this.name+' experienced a "drawFill" drawImage glitch')}}return this},a.Picture.prototype.fillDraw=function(b,c){var d,e,f;if(this.imageType){d=this.prepareStamp(),e=this.width*this.scale,f=this.height*this.scale,this.rotateCell(b),a.cell[c].setEngine(this);try{b.drawImage(this.getImage(),this.copyX,this.copyY,this.copyWidth,this.copyHeight,d.x,d.y,e,f)}catch(g){console.log("Picture "+this.name+' experienced a "fillDraw" drawImage glitch')}this.clearShadow(b,c),b.strokeRect(d.x,d.y,e,f)}return this},a.Picture.prototype.sinkInto=function(b,c){var d,e,f;if(this.imageType){d=this.prepareStamp(),e=this.width*this.scale,f=this.height*this.scale,this.rotateCell(b),a.cell[c].setEngine(this);try{b.drawImage(this.getImage(),this.copyX,this.copyY,this.copyWidth,this.copyHeight,d.x,d.y,e,f)}catch(g){console.log("Picture "+this.name+' experienced a "sinkInto" drawImage glitch')}b.strokeRect(d.x,d.y,e,f)}return this},a.Picture.prototype.floatOver=function(b,c){var d,e,f;if(this.imageType){d=this.prepareStamp(),e=this.width*this.scale,f=this.height*this.scale,this.rotateCell(b),a.cell[c].setEngine(this),b.strokeRect(d.x,d.y,e,f);try{b.drawImage(this.getImage(),this.copyX,this.copyY,this.copyWidth,this.copyHeight,d.x,d.y,e,f)}catch(g){console.log("Picture "+this.name+' experienced a "floatOver" drawImage glitch')}}return this},a.Picture.prototype.getImageData=function(b){b=a.xt(b)?b:"data";var c,d=this.getImage();if("animation"===this.imageType)c=a.image[this.source],a.cv.width=c.get("width"),a.cv.height=c.get("height"),a.cvx.drawImage(d,0,0);else{a.cv.width=this.copyWidth,a.cv.height=this.copyHeight;try{a.cvx.drawImage(d,this.copyX,this.copyY,this.copyWidth,this.copyHeight,0,0,this.copyWidth,this.copyHeight)}catch(e){console.log("Picture "+this.name+' experienced a "getImageData" drawImage glitch')}}return this.imageData=this.name+"_"+b,a.imageData[this.imageData]=a.cvx.getImageData(0,0,a.cv.width,a.cv.height),this},a.Picture.prototype.getImageDataValue=function(b){var c,d,e,f,g,h,i,j=this.getLocalCoordinate(b),k=a.imageData[this.get("imageData")],l=this.get("imageDataChannel");if("animation"===this.imageType&&a.image[this.source]?(e=a.anim[this.get("animSheet")].getData(),f=this.width/e.copyWidth,g=this.height/e.copyHeight,c=Math.round(j.x/f+e.copyX),d=Math.round(j.y/g+e.copyY)):(f=this.width/this.copyWidth,g=this.height/this.copyHeight,c=Math.round(j.x/f),d=Math.round(j.y/g)),h=!1,i=4*(d*k.width+c),a.isBetween(c,0,k.width-1,!0)&&a.isBetween(d,0,k.height-1,!0))switch(b.channel||l){case"red":h=a.xt(k.data[i])?k.data[i]:!1;break;case"blue":h=a.xt(k.data[i+1])?k.data[i+1]:!1;break;case"green":h=a.xt(k.data[i+2])?k.data[i+2]:!1;break;case"alpha":h=a.xt(k.data[i+3])?k.data[i+3]:!1;break;case"color":h=a.xta([k.data[i],k.data[i+1],k.data[i+2],k.data[i+3]])?"rgba("+k.data[i]+","+k.data[i+1]+","+k.data[i+2]+","+k.data[i+3]+")":!1;break;default:h=!1}return h},a.Picture.prototype.getImage=function(){var b,c;switch(this.imageType){case"canvas":c=a.canvas[this.source];break;case"animation":b=a.anim[this.animSheet].getData(),this.set({copyX:b.copyX,copyY:b.copyY,copyWidth:b.copyWidth,copyHeight:b.copyHeight}),c=a.xt(a.img[this.source])?a.img[this.source]:a.object[this.source];break;default:c=a.xt(a.img[this.source])?a.img[this.source]:a.object[this.source]}return c},a.Picture.prototype.checkHit=function(b){b=a.safeObject(b);var c,d,e=a.Sprite.prototype.checkHit.call(this,b);return this.checkHitUsingImageData&&e?(e.x=parseInt(e.x),e.y=parseInt(e.y),c=this.getImageDataValue(e),"color"===this.get("imageDataChannel")?"rgba(0,0,0,0)"===c?!1:e:(d=a.isa(b.test,"num")?b.test:0,c>d?e:!1)):e},a.ScrawlImage=function(b){b=a.safeObject(b);var c,d=a.xt(b.imageData)?b.imageData:{},e=a.xt(b.element)?b.element:{},f=a.xt(b.makeCopy)?b.makeCopy:!1;return a.xto([b.element,b.imageData])?(b.name=b.name||e.getAttribute("id")||e.getAttribute("name")||e.getAttribute("src"),a.Base.call(this,b),this.width=b.width||d.width||parseFloat(e.offsetWidth)||e.width||e.style.width||0,this.height=b.height||d.height||parseFloat(e.offsetHeight)||e.height||e.style.height||0,a.xt(b.element)&&f?(c=a.xt(b.element)?this.getImageDataUrl(e):d,a.img[this.name]=this.makeImage(c)):(a.object[this.name]=e,a.pushUnique(a.objectnames,this.name)),a.image[this.name]=this,a.pushUnique(a.imagenames,this.name),this.source=b.source||this.name||"",a.isa(b.fn,"fn")&&b.fn.call(this),this):!1},a.ScrawlImage.prototype=Object.create(a.Base.prototype),a.ScrawlImage.prototype.type="ScrawlImage",a.ScrawlImage.prototype.classname="imagenames",a.d.ScrawlImage={width:0,height:0,source:""},a.mergeInto(a.d.ScrawlImage,a.d.Base),a.ScrawlImage.prototype.makeImage=function(a){var b=document.createElement("img");return b.width=this.width,b.height=this.height,b.crossorigin="anonymous",b.src=a,b},a.ScrawlImage.prototype.getImageDataUrl=function(b,c){return c=a.xt(c)?c:!1,a.cv.width=this.width,a.cv.height=this.height,c?a.cvx.putImageData(b,0,0):a.cvx.drawImage(b,0,0),a.cv.toDataURL()},a.ScrawlImage.prototype.getImageData=function(b){b=a.xt(b)?b:!1;var c;return a.isa(b,"bool")?(c=b?a.object[this.source]:a.img[this.name],a.cv.width=this.width,a.cv.height=this.height,a.cvx.drawImage(c,0,0),a.cvx.getImageData(0,0,this.width,this.height)):b},a.ScrawlImage.prototype.clone=function(b){return b=a.safeObject(b),b.element=a.xt(a.img[this.name])?a.img[this.name]:a.object[this.source],b.makeCopy=!0,a.Base.prototype.clone.call(this,b)},a.ScrawlImage.prototype.grayscale=function(b){return a.xt(a.filter)?a.filter.grayscale(b,this):!1},a.ScrawlImage.prototype.sharpen=function(b){return a.xt(a.filter)?a.filter.sharpen(b,this):!1},a.ScrawlImage.prototype.invert=function(b){return a.xt(a.filter)?a.filter.invert(b,this):!1},a.ScrawlImage.prototype.brightness=function(b){return a.xt(a.filter)?a.filter.brightness(b,this):!1},a.ScrawlImage.prototype.saturation=function(b){return a.xt(a.filter)?a.filter.saturation(b,this):!1},a.ScrawlImage.prototype.threshold=function(b){return a.xt(a.filter)?a.filter.threshold(b,this):!1},a.ScrawlImage.prototype.channels=function(b){return a.xt(a.filter)?a.filter.channels(b,this):!1},a.ScrawlImage.prototype.channelStep=function(b){return a.xt(a.filter)?a.filter.channelStep(b,this):!1},a.ScrawlImage.prototype.sepia=function(b){return a.xt(a.filter)?a.filter.sepia(b,this):!1},a.ScrawlImage.prototype.tint=function(b){return a.xt(a.filter)?a.filter.tint(b,this):!1},a.ScrawlImage.prototype.blur=function(b){return a.xt(a.filter)?a.filter.blur(b,this):!1},a.ScrawlImage.prototype.pixelate=function(b){return a.xt(a.filter)?a.filter.pixelate(b,this):!1},a.ScrawlImage.prototype.matrix=function(b){return a.xt(a.filter)?a.filter.matrix(b,this):!1},a.AnimSheet=function(b){return b=a.safeObject(b),a.Base.call(this,b),this.frames=a.xt(b.frames)?[].concat(b.frames):[],this.currentFrame=b.currentFrame||0,this.speed=a.isa(b.speed,"num")?b.speed:1,this.loop=a.isa(b.loop,"str")?b.loop:"end",this.running=a.isa(b.running,"str")?b.running:"complete",this.lastCalled=a.xt(b.lastCalled)?b.lastCalled:Date.now(),a.anim[this.name]=this,a.pushUnique(a.animnames,this.name),this},a.AnimSheet.prototype=Object.create(a.Base.prototype),a.AnimSheet.prototype.type="AnimSheet",a.AnimSheet.prototype.classname="animnames",a.d.AnimSheet={frames:[],currentFrame:0,speed:1,loop:"end",running:"complete",lastCalled:0},a.animKeys=Object.keys(a.d.AnimSheet),a.mergeInto(a.d.AnimSheet,a.d.Scrawl),a.AnimSheet.prototype.set=function(b){b=a.safeObject(b);var c="pause"===this.loop?!0:!1;if(a.Base.prototype.set.call(this,b),a.xt(b.running))switch(b.running){case"forward":this.running="forward",c||(this.currentFrame=0);break;case"backward":this.running="backward",c||(this.currentFrame=this.frames.length-1);break;default:this.running="complete",this.currentFrame=0}return this},a.AnimSheet.prototype.getData=function(){if(this.speed>0){var a=this.frames[this.currentFrame].d/this.speed,b=this.lastCalled+a<Date.now()?!0:!1;switch(this.running){case"complete":this.lastCalled=Date.now();break;case"forward":if(b){switch(this.loop){case"pause":break;case"end":this.running=this.currentFrame+1>=this.frames.length?"complete":this.running,this.currentFrame=this.currentFrame+1>=this.frames.length?this.currentFrame:this.currentFrame+1;break;case"loop":this.currentFrame=this.currentFrame+1>=this.frames.length?0:this.currentFrame+1;break;case"reverse":this.running=this.currentFrame+1>=this.frames.length?"backward":"forward",this.currentFrame=this.currentFrame+1>=this.frames.length?this.currentFrame:this.currentFrame+1}this.lastCalled=Date.now()}break;case"backward":if(b){switch(this.loop){case"pause":break;case"end":this.running=this.currentFrame-1<=0?"complete":this.running,this.currentFrame=this.currentFrame-1<=0?this.currentFrame:this.currentFrame-1;break;case"loop":this.currentFrame=this.currentFrame-1<=0?this.frames.length-1:this.currentFrame-1;break;case"reverse":this.running=this.currentFrame-1<=0?"forward":"backward",this.currentFrame=this.currentFrame-1<=0?this.currentFrame:this.currentFrame-1}this.lastCalled=Date.now()}}}return{copyX:this.frames[this.currentFrame].x,copyY:this.frames[this.currentFrame].y,copyWidth:this.frames[this.currentFrame].w,copyHeight:this.frames[this.currentFrame].h}},a}(scrawl);