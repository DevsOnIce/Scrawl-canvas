/*! scrawl 2014-04-05 */
"use strict";var scrawl=function(a){return a.filternames=["grayscale","sharpen","mergeImages","invert","brightness","saturation","threshold","channels","channelStep","sepia","tint","blur","getBrush","pixelate","matrix","doMatrix"],a.filter={grayscale:function(b,c){b=a.safeObject(b);var d,e,f=a.xt(b.value)?b.value:1,g=a.xt(b.useSourceData)?b.useSourceData:!1,h=b.use||c.getImageData(g),i=h.data,j=a.xt(b.save)?b.save:!0;f=a.isa(f,"str")?parseFloat(f)/100:f,f=a.isBetween(f,0,1,!0)?f:f>.5?1:0;for(var k=0,l=i.length;l>k;k+=4)d=Math.floor(.2126*i[k]+.7152*i[k+1]+.0722*i[k+2]),i[k]=i[k]+(d-i[k])*f,i[k+1]=i[k+1]+(d-i[k+1])*f,i[k+2]=i[k+2]+(d-i[k+2])*f;return j&&(e=c.getImageDataUrl(h,!0),a.img[c.name]=c.makeImage(e)),h},sharpen:function(b,c){b=a.safeObject(b);var d,e,f,g=a.xt(b.value)?b.value:1,h=a.xt(b.useSourceData)?b.useSourceData:!1,i=b.use||c.getImageData(h),j=a.xt(b.save)?b.save:!0;return g=a.isa(g,"str")?parseFloat(g)/100:g,d=a.filter.matrix({useSourceData:h,data:[0,-1,0,-1,5,-1,0,-1,0],save:!1},c),e=a.filter.mergeImages({image1:i,image2:d,value:g}),j&&(f=c.getImageDataUrl(e,!0),a.img[c.name]=c.makeImage(f)),e},mergeImages:function(b){if(a.isa(b,"obj")&&a.xta([b.image1,b.image2,b.value])){var c=b.image1,d=c.data,e=b.image2,f=e.data,g=b.value;if(0===g)return c;if(1===g)return e;for(var h=0,i=d.length;i>h;h+=4)d[h]=d[h]*(1-g)+f[h]*g,d[h+1]=d[h+1]*(1-g)+f[h+1]*g,d[h+2]=d[h+2]*(1-g)+f[h+2]*g;return c}return!1},invert:function(b,c){b=a.safeObject(b);var d,e=a.xt(b.value)?b.value:1,f=a.xt(b.useSourceData)?b.useSourceData:!1,g=b.use||c.getImageData(f),h=g.data,i=a.xt(b.save)?b.save:!0;e=a.isa(e,"str")?parseFloat(e)/100:e,e=a.isBetween(e,0,1,!0)?e:e>.5?1:0;for(var j=0,k=h.length;k>j;j+=4)h[j]=h[j]*(1-e)+(255-h[j])*e,h[j+1]=h[j+1]*(1-e)+(255-h[j+1])*e,h[j+2]=h[j+2]*(1-e)+(255-h[j+2])*e;return i&&(d=c.getImageDataUrl(g,!0),a.img[c.name]=c.makeImage(d)),g},brightness:function(b,c){b=a.safeObject(b);var d,e=a.xt(b.value)?b.value:1,f=b.use||a.xt(b.useSourceData)?b.useSourceData:!1,g=c.getImageData(f),h=g.data,i=a.xt(b.save)?b.save:!0;e=a.isa(e,"str")?parseFloat(e)/100:e,e=0>e?0:e;for(var j=0,k=h.length;k>j;j+=4)h[j]=h[j]*e,h[j+1]=h[j+1]*e,h[j+2]=h[j+2]*e;return i&&(d=c.getImageDataUrl(g,!0),a.img[c.name]=c.makeImage(d)),g},saturation:function(b,c){b=a.safeObject(b);var d,e=a.xt(b.value)?b.value:1,f=b.use||a.xt(b.useSourceData)?b.useSourceData:!1,g=c.getImageData(f),h=g.data,i=a.xt(b.save)?b.save:!0;e=a.isa(e,"str")?parseFloat(e)/100:e,e=0>e?0:e;for(var j=0,k=h.length;k>j;j+=4)h[j]=127+(h[j]-127)*e,h[j+1]=127+(h[j+1]-127)*e,h[j+2]=127+(h[j+2]-127)*e;return i&&(d=c.getImageDataUrl(g,!0),a.img[c.name]=c.makeImage(d)),g},threshold:function(b,c){b=a.safeObject(b);var d,e,f,g=a.xt(b.value)?b.value:.5,h=a.xt(b.save)?b.save:!0;g=a.isa(g,"str")?parseFloat(g)/100:g,g=a.isBetween(g,0,1,!0)?g:g>.5?1:0,g*=255,f=a.filter.grayscale({useSourceData:b.useSourceData,use:b.use,save:!1},c),d=c.getImageData(f),e=d.data;for(var i=0,j=e.length;j>i;i+=4)e[i]=e[i]>g?255:0,e[i+1]=e[i+1]>g?255:0,e[i+2]=e[i+2]>g?255:0;return h&&(f=c.getImageDataUrl(d,!0),a.img[c.name]=c.makeImage(f)),d},channels:function(b,c){b=a.safeObject(b);var d,e=a.xt(b.red)?b.red:1,f=a.xt(b.green)?b.green:1,g=a.xt(b.blue)?b.blue:1,h=a.xt(b.alpha)?b.alpha:1,i=b.use||a.xt(b.useSourceData)?b.useSourceData:!1,j=c.getImageData(i),k=j.data,l=a.xt(b.save)?b.save:!0;e=a.isa(e,"str")?parseFloat(e)/100:e,f=a.isa(f,"str")?parseFloat(f)/100:f,g=a.isa(g,"str")?parseFloat(g)/100:g,h=a.isa(h,"str")?parseFloat(h)/100:h;for(var m=0,n=k.length;n>m;m+=4)k[m]=k[m]*e,k[m+1]=k[m+1]*f,k[m+2]=k[m+2]*g,k[m+3]=k[m+3]*h;return l&&(d=c.getImageDataUrl(j,!0),a.img[c.name]=c.makeImage(d)),j},channelStep:function(b,c){b=a.safeObject(b);for(var d,e=a.xt(b.red)?b.red:1,f=a.xt(b.green)?b.green:1,g=a.xt(b.blue)?b.blue:1,h=a.xt(b.alpha)?b.alpha:1,i=b.use||a.xt(b.useSourceData)?b.useSourceData:!1,j=c.getImageData(i),k=j.data,l=a.xt(b.save)?b.save:!0,m=0,n=k.length;n>m;m+=4)k[m]=Math.floor(k[m]/e)*e,k[m+1]=Math.floor(k[m+1]/f)*f,k[m+2]=Math.floor(k[m+2]/g)*g,k[m+3]=Math.floor(k[m+3]/h)*h;return l&&(d=c.getImageDataUrl(j,!0),a.img[c.name]=c.makeImage(d)),j},sepia:function(b,c){return b=a.safeObject(b),b.rr=.393,b.rg=.349,b.rb=.272,b.gr=.769,b.gg=.686,b.gb=.534,b.br=.189,b.bg=.168,b.bb=.131,a.filter.tint(b,c)},tint:function(b,c){b=a.safeObject(b);var d,e,f,g,h=a.xt(b.value)?b.value:1,i=b.use||a.xt(b.useSourceData)?b.useSourceData:!1,j=b.rr||b.redInRed||.393,k=b.rg||b.redInGreen||.349,l=b.rb||b.redInBlue||.272,m=b.gr||b.greenInRed||.769,n=b.gg||b.greenInGreen||.686,o=b.gb||b.greenInBlue||.534,p=b.br||b.blueInRed||.189,q=b.bg||b.blueInGreen||.168,r=b.bb||b.blueInBlue||.131,s=c.getImageData(i),t=s.data,u=a.xt(b.save)?b.save:!0;h=a.isa(h,"str")?parseFloat(h)/100:h,h=a.isBetween(h,0,1,!0)?h:h>.5?1:0;for(var v=0,w=t.length;w>v;v+=4)d=t[v]*j+t[v+1]*m+t[v+2]*p,e=t[v]*k+t[v+1]*n+t[v+2]*q,f=t[v]*l+t[v+1]*o+t[v+2]*r,t[v]=t[v]*(1-h)+d*h,t[v+1]=t[v+1]*(1-h)+e*h,t[v+2]=t[v+2]*(1-h)+f*h;return u&&(g=c.getImageDataUrl(s,!0),a.img[c.name]=c.makeImage(g)),s},blur:function(b,c){b=a.safeObject(b);var d,e=a.xt(b.radius)?Math.abs(b.radius):0,f=a.xt(b.radiusX)?Math.abs(b.radiusX):2,g=a.xt(b.radiusY)?Math.abs(b.radiusY):2,h=a.xt(b.roll)?b.roll:0,i=e||f||2,j=e||g||2,k=b.use||a.xt(b.useSourceData)?b.useSourceData:!1,l=a.xt(b.includeAlpha)?b.includeAlpha:!1,m=a.filter.getBrush(i,j,h),n=a.xt(b.save)?b.save:!0,o=a.filter.doMatrix(m,k,l,!1,c);return n&&(d=c.getImageDataUrl(o,!0),a.img[c.name]=c.makeImage(d)),o},getBrush:function(b,c,d){var e=b>c?b+2:c+2,f=Math.floor(e/2),g=Math.cos(d*a.radian),h=Math.sin(d*a.radian),i=[];a.cv.width=e,a.cv.height=e,a.cvx.setTransform(g,h,-h,g,f,f),a.cvx.beginPath(),a.cvx.moveTo(0,-c),a.cvx.bezierCurveTo(.55*b,-c,b,.55*-c,b,0),a.cvx.bezierCurveTo(b,.55*c,.55*b,c,0,c),a.cvx.bezierCurveTo(.55*-b,c,-b,.55*c,-b,0),a.cvx.bezierCurveTo(-b,.55*-c,.55*-b,-c,0,-c),a.cvx.closePath();for(var j=0;e>j;j++)for(var k=0;e>k;k++)a.cvx.isPointInPath(k,j)&&i.push({ox:k-f,oy:j-f,wt:1});return a.cvx.setTransform(1,0,0,1,0,0),i},pixelate:function(b,c){b=a.safeObject(b);var d,e,f,g,h,i,j,k,l,m,n=a.xt(b.width)?Math.ceil(b.width):5,o=a.xt(b.height)?Math.ceil(b.height):5,p=b.use||a.xt(b.useSourceData)?b.useSourceData:!1,q=a.xt(b.includeAlpha)?b.includeAlpha:!1,r=c.getImageData(p),s=a.xt(b.save)?b.save:!0;a.cv.width=r.width,a.cv.height=r.height,a.cvx.putImageData(r,0,0);for(var t=0;t<r.height;t+=o)for(var u=0;u<r.width;u+=n){d=e=f=g=i=0,j=u+n>r.width?r.width-u:n,k=t+o>r.height?r.height-t:o,l=j*k*4,h=a.cvx.getImageData(u,t,j,k);for(var v=0;l>v;v+=4)h.data[v+3]>0&&(d+=h.data[v],e+=h.data[v+1],f+=h.data[v+2],g+=h.data[v+3],i++);d=Math.floor(d/i),e=Math.floor(e/i),f=Math.floor(f/i),g=Math.floor(g/i),a.cvx.fillStyle=q?"rgba("+d+","+e+","+f+","+g+")":"rgb("+d+","+e+","+f+")",a.cvx.fillRect(u,t,j,k)}return h=a.cvx.getImageData(0,0,r.width,r.height),s&&(m=c.getImageDataUrl(h,!0),a.img[c.name]=c.makeImage(m)),h},matrix:function(b,c){b=a.safeObject(b);var d,e,f,g,h,i,j=a.xt(b.useSourceData)?b.useSourceData:!1,k=a.xt(b.includeAlpha)?b.includeAlpha:!1,l=a.isa(b.wrap,"bool")?b.wrap:!1,m=a.isa(b.data,"arr")?b.data:[1],n=[],o=0,p=a.xt(b.save)?b.save:!0;d=Math.ceil(Math.sqrt(m.length)),d=d%2===1?Math.pow(d,2):Math.pow(d+1,2);for(var q=0;d>q;q++)m[q]=a.xt(m[q])?parseFloat(m[q]):0,m[q]=isNaN(m[q])?0:m[q];e=Math.floor(m.length/2),f=Math.sqrt(m.length),g=Math.floor(f/2);for(var q=0;f>q;q++)for(var r=0;f>r;r++)0!==m[o]&&n.push({ox:r-g,oy:q-g,wt:m[o]}),o++;return h=a.filter.doMatrix(n,j,k,l,c),p&&(i=c.getImageDataUrl(h,!0),a.img[c.name]=c.makeImage(i)),h},doMatrix:function(b,c,d,e,f){e=a.isa(e,"bool")?e:!1;var g,h,i,j,k,l,m,n=f.getImageData(c),o=n.data,p=f.getImageData(c),q=p.data,r=0;if(b.length>0){for(var s=0;s<n.height;s++)for(var t=0;t<n.width;t++){g=i=h=j=r=0,k=4*(s*n.width+t);for(var u=0,v=b.length;v>u;u++)m=!0,a.isBetween(t+b[u].ox,0,n.width-1,!0)&&a.isBetween(s+b[u].oy,0,n.height-1,!0)||(e?(a.isBetween(t+b[u].ox,0,n.width-1,!0)||(b[u].ox+=b[u].ox>0?-n.width:n.width),a.isBetween(s+b[u].oy,0,n.height-1,!0)||(b[u].oy+=b[u].oy>0?-n.height:n.height)):m=!1),m&&(l=k+4*(b[u].oy*n.width+b[u].ox),g+=o[l]*b[u].wt,h+=o[l+1]*b[u].wt,i+=o[l+2]*b[u].wt,r+=b[u].wt,d&&(j+=o[l+3]*b[u].wt));q[k]=0!==r?g/r:g,q[k+1]=0!==r?h/r:h,q[k+2]=0!==r?i/r:i,d&&(q[k+3]=0!==r?j/r:j)}return p}return!1}},a}(scrawl);