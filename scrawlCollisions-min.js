/*! scrawl 2014-04-05 */
"use strict";var scrawl=function(a){return a.buildFields=function(b){var c=a.xt(b)?[].concat(b):[a.pad[a.currentPad].current];"all"===b&&(c=a.cellnames);for(var d=0,e=c.length;e>d;d++)a.cell[c[d]].buildField();return!0},a.Pad.prototype.buildFields=function(){for(var b=0,c=this.cells.length;c>b;b++)a.cell[this.cells[b]].buildField();return this},a.Cell.prototype.collisionsCellInit=function(b){a.newGroup({name:this.name+"_field",cell:this.name,visibility:!1}),b.field&&(a.group[this.name+"_field"].sprites=[].concat(b.field)),a.newGroup({name:this.name+"_fence",cell:this.name,visibility:!1}),b.fence&&(a.group[this.name+"_fence"].sprites=[].concat(b.fence))},a.d.Cell.fieldLabel="",a.Cell.prototype.buildField=function(){var b,c,d=[],e=[],f="",g=a.ctx[this.context].get("fillStyle");a.context[this.context].fillStyle="rgba(0,0,0,1)",a.context[this.context].fillRect(0,0,this.actualWidth,this.actualHeight),a.context[this.context].fillStyle=g,d=a.group[this.name+"_field"].sprites;for(var h=0,i=d.length;i>h;h++)f=a.sprite[d[h]],b=a.ctx[f.context].fillStyle,c=a.ctx[f.context].strokeStyle,a.ctx[f.context].fillStyle="rgba(255,255,255,1)",a.ctx[f.context].strokeStyle="rgba(255,255,255,1)",f.forceStamp("fillDraw",this.name),a.ctx[f.context].fillStyle=b,a.ctx[f.context].strokeStyle=c;e=a.group[this.name+"_fence"].sprites;for(var h=0,i=e.length;i>h;h++)f=a.sprite[e[h]],b=a.ctx[f.context].fillStyle,c=a.ctx[f.context].strokeStyle,a.ctx[f.context].fillStyle="rgba(0,0,0,1)",a.ctx[f.context].strokeStyle="rgba(0,0,0,1)",f.forceStamp("fillDraw",this.name),a.ctx[f.context].fillStyle=b,a.ctx[f.context].strokeStyle=c;return this.set({fieldLabel:this.getImageData({name:"field"})}),this},a.Cell.prototype.checkFieldAt=function(b){b=a.safeObject(b);var c,d,e,f,g=b.channel||"anycolor",h=b.test||0,i=b.coordinates?b.coordinates:[{x:b.x||0,y:b.y||0}],j=this.get("fieldLabel");f=a.imageData[j];for(var k=0,l=i.length;l>k;k++){if(c=Math.round(i[k].x),d=Math.round(i[k].y),!a.isBetween(c,0,f.width,!0)||!a.isBetween(d,0,f.height,!0))return!1;switch(e=4*(d*f.width+c),g){case"red":if(f.data[e]<=h)return i[k];break;case"green":if(f.data[e+1]<=h)return i[k];break;case"blue":if(f.data[e+2]<=h)return i[k];break;case"alpha":if(f.data[e+3]<=h)return i[k];break;case"anycolor":if(f.data[e]<=h||f.data[e+1]<=h||f.data[e+2]<=h)return i[k]}}return!0},a.Group.prototype.getSpritesCollidingWith=function(b){if(b=a.isa(b,"str")?a.sprite[b]:b,a.contains(a.spritenames,b.name)){for(var c=[],d=b.getCollisionPoints(),e=0,f=this.sprites.length;f>e;e++)a.sprite[this.sprites[e]].name!==b.name&&a.sprite[this.sprites[e]].get("visibility")&&a.sprite[this.sprites[e]].checkHit({tests:d})&&c.push(this.sprites[e]);return c.length>0?c:!1}return!1},a.Group.prototype.getInGroupSpriteHits=function(){for(var b,c,d,e,f=[],g={},h={},i=0,j=this.sprites.length;j>i;i++)b=a.sprite[this.sprites[i]],h[b.name]=b.visibility,h[b.name]&&(g[b.name]=b.getCollisionPoints());for(var i=0,j=this.sprites.length;j>i;i++)if(h[this.sprites[i]]){c=a.sprite[this.sprites[i]].start;for(var k=i+1,l=this.sprites.length;l>k;k++)if(h[this.sprites[k]]){if(d=a.sprite[this.sprites[k]].start,this.regionRadius&&(e=c.getVectorSubtract(d).getMagnitude(),e>this.regionRadius))continue;if(a.sprite[this.sprites[k]].checkHit({tests:g[this.sprites[i]]})){f.push([this.sprites[i],this.sprites[k]]);continue}if(a.sprite[this.sprites[i]].checkHit({tests:g[this.sprites[k]]})){f.push([this.sprites[i],this.sprites[k]]);continue}}}return f},a.Group.prototype.getBetweenGroupSpriteHits=function(b){var c,d,e,f,g=[],h={},i={};if(a.xt(b)){if(a.isa(b,"str")){if(!a.contains(a.groupnames,b))return!1;b=a.group[b]}else if(!a.xt(b.type)||"Group"!==b.type)return!1;for(var j=0,k=this.sprites.length;k>j;j++)c=a.sprite[this.sprites[j]],i[c.name]=c.visibility,i[c.name]&&(h[c.name]=c.getCollisionPoints());for(var j=0,k=b.sprites.length;k>j;j++)c=a.sprite[b.sprites[j]],i[c.name]=c.visibility,i[c.name]&&(h[c.name]=c.getCollisionPoints());for(var j=0,k=this.sprites.length;k>j;j++)if(i[this.sprites[j]]){d=a.sprite[this.sprites[j]].start;for(var l=0,m=b.sprites.length;m>l;l++)if(i[b.sprites[l]]){if(e=a.sprite[b.sprites[l]].start,this.regionRadius&&(f=d.getVectorSubtract(e).getMagnitude(),f>this.regionRadius))continue;if(a.sprite[b.sprites[l]].checkHit({tests:h[this.sprites[j]]})){g.push([this.sprites[j],b.sprites[l]]);continue}if(a.sprite[this.sprites[j]].checkHit({tests:h[b.sprites[l]]})){g.push([this.sprites[j],b.sprites[l]]);continue}}}return g}return!1},a.Group.prototype.getFieldSpriteHits=function(b){b=a.xt(b)?b:this.cell;for(var c,d=[],e=0,f=this.sprites.length;f>e;e++)c=a.sprite[this.sprites[e]].checkField(b),a.isa(c,"bool")||d.push([this.sprites[e],c]);return d},a.d.Sprite.fieldChannel="anycolor",a.d.Sprite.fieldTest=0,a.d.Sprite.collisionVectors=[],a.d.Sprite.collisionPoints=[],a.xt(a.d.Block)&&a.mergeInto(a.d.Block,a.d.Sprite),a.xt(a.d.Shape)&&a.mergeInto(a.d.Shape,a.d.Sprite),a.xt(a.d.Wheel)&&a.mergeInto(a.d.Wheel,a.d.Sprite),a.xt(a.d.Picture)&&a.mergeInto(a.d.Picture,a.d.Sprite),a.xt(a.d.Phrase)&&a.mergeInto(a.d.Phrase,a.d.Sprite),a.xt(a.d.Path)&&a.mergeInto(a.d.Path,a.d.Sprite),a.Sprite.prototype.collisionsSpriteConstructor=function(b){a.xt(b.field)&&this.addSpriteToCellFields(),a.xt(b.fence)&&this.addSpriteToCellFences()},a.Sprite.prototype.collisionsSpriteRegisterInLibrary=function(){return a.xt(this.collisionPoints)&&(this.collisionPoints=a.isa(this.collisionPoints,"arr")?this.collisionPoints:[this.collisionPoints],this.collisionPoints=this.parseCollisionPoints(this.collisionPoints)),this},a.Sprite.prototype.collisionsSpriteSet=function(b){a.xto([b.collisionPoints,b.field,b.fence])&&(a.xt(b.collisionPoints)&&(this.collisionPoints=a.isa(b.collisionPoints,"arr")?b.collisionPoints:[b.collisionPoints],this.collisionPoints=this.parseCollisionPoints(this.collisionPoints),delete this.collisionVectors),a.xt(b.field)&&this.addSpriteToCellFields(),a.xt(b.fence)&&this.addSpriteToCellFences())},a.Sprite.prototype.addSpriteToCellFields=function(b){b=a.xt(b)?[].concat(b):[this.group];for(var c=0,d=b.length;d>c;c++)a.contains(a.cellnames,b[c])&&a.group[b[c]+"_field"].addSpritesToGroup(this.name);return this},a.Sprite.prototype.addSpriteToCellFences=function(b){b=a.xt(b)?[].concat(b):[this.group];for(var c=0,d=b.length;d>c;c++)a.contains(a.cellnames,b[c])&&a.group[b[c]+"_fence"].addSpritesToGroup(this.name);return this},a.Sprite.prototype.removeSpriteFromCellFields=function(b){b=a.xt(b)?[].concat(b):[this.group];for(var c=0,d=b.length;d>c;c++)a.contains(a.cellnames,b[c])&&a.group[b[c]+"_field"].removeSpritesFromGroup(this.name);return this},a.Sprite.prototype.removeSpriteFromCellFences=function(b){b=a.xt(b)?[].concat(b):[this.group];for(var c=0,d=b.length;d>c;c++)a.contains(a.cellnames,b[c])&&a.group[b[c]+"_fence"].removeSpritesFromGroup(this.name);return this},a.Sprite.prototype.checkField=function(b){var c=b?a.cell[b]:a.cell[a.group[this.group].cell];return c.checkFieldAt({coordinates:this.getCollisionPoints(),test:this.get("fieldTest"),channel:this.get("fieldChannel")})},a.Sprite.prototype.bounceOnFieldCollision=function(b,c){var d,e,f,g,h=c?a.cell[c]:a.cell[a.group[this.group].cell],i=this.start.getVector(),j=b.getVectorSubtract(i),k=j.getVector(),l=j.getVector(),m=!1,n=!1,o=this.get("fieldTest"),p=this.get("fieldChannel"),q=0,r=function(){var a=h.checkFieldAt({coordinates:[d.vectorAdd(i)],test:o,channel:p});return a};do d=k.rotate(-10).getVector(),m=r(),q++;while(36>q&&m!==!0);q=0;do d=k.rotate(1).getVector(),m=r(),q++;while(10>=q&&m===!0);q=0;do d=l.rotate(10).getVector(),n=r(),q++;while(36>q&&n!==!0);q=0;do d=l.rotate(-1).getVector(),n=r(),q++;while(10>=q&&n===!0);return k.vectorAdd(i),l.vectorAdd(i),e=Math.atan2(k.y-l.y,k.x-l.x)/a.radian,g=Math.atan2(this.delta.y,this.delta.x)/a.radian,f=2*(e-g),this.delta.rotate(f),this},a.Sprite.prototype.getCollisionPoints=function(){var b,c,d=[];if(a.xt(this.collisionVectors)||a.xt(this.collisionPoints)&&this.buildCollisionVectors(),c=this.collisionVectors||!1){for(var e=0,f=c.length;f>e;e++)b=c[e].getVector(),b.x=this.flipReverse?-b.x:b.x,b.y=this.flipUpend?-b.y:b.y,this.roll&&b.rotate(this.roll),1!==this.scale&&b.scalarMultiply(this.scale),b.vectorAdd(this.start),d.push(b);return d}return[]},a.Sprite.prototype.buildCollisionVectors=function(b){var c,d=this.getPivotOffsetVector(),e=this.width,f=this.height;c=a.xt(b)?this.parseCollisionPoints(b):this.collisionPoints,this.collisionVectors=[];for(var g=0,h=c.length;h>g;g++)if(a.isa(c[g],"str"))switch(c[g]){case"start":this.collisionVectors.push(a.newVector());break;case"N":this.collisionVectors.push(a.newVector({x:e/2-d.x,y:-d.y}));break;case"NE":this.collisionVectors.push(a.newVector({x:e-d.x,y:-d.y}));break;case"E":this.collisionVectors.push(a.newVector({x:e-d.x,y:f/2-d.y}));break;case"SE":this.collisionVectors.push(a.newVector({x:e-d.x,y:f-d.y}));break;case"S":this.collisionVectors.push(a.newVector({x:e/2-d.x,y:f-d.y}));break;case"SW":this.collisionVectors.push(a.newVector({x:-d.x,y:f-d.y}));break;case"W":this.collisionVectors.push(a.newVector({x:-d.x,y:f/2-d.y}));break;case"NW":this.collisionVectors.push(a.newVector({x:-d.x,y:-d.y}));break;case"center":this.collisionVectors.push(a.newVector({x:e/2-d.x,y:f/2-d.y}))}else a.isa(c[g],"vector")&&this.collisionVectors.push(c[g]);return this},a.Sprite.prototype.parseCollisionPoints=function(b){for(var c=a.xt(b)?[].concat(b):[],d=[],e=0,f=c.length;f>e;e++)if(a.isa(c[e],"str"))switch(c[e].toLowerCase()){case"all":a.pushUnique(d,"N"),a.pushUnique(d,"NE"),a.pushUnique(d,"E"),a.pushUnique(d,"SE"),a.pushUnique(d,"S"),a.pushUnique(d,"SW"),a.pushUnique(d,"W"),a.pushUnique(d,"NW"),a.pushUnique(d,"start"),a.pushUnique(d,"center");break;case"corners":a.pushUnique(d,"NE"),a.pushUnique(d,"SE"),a.pushUnique(d,"SW"),a.pushUnique(d,"NW");break;case"edges":a.pushUnique(d,"N"),a.pushUnique(d,"E"),a.pushUnique(d,"S"),a.pushUnique(d,"W");break;case"perimeter":a.pushUnique(d,"N"),a.pushUnique(d,"NE"),a.pushUnique(d,"E"),a.pushUnique(d,"SE"),a.pushUnique(d,"S"),a.pushUnique(d,"SW"),a.pushUnique(d,"W"),a.pushUnique(d,"NW");break;case"north":case"n":a.pushUnique(d,"N");break;case"northeast":case"ne":a.pushUnique(d,"NE");break;case"east":case"e":a.pushUnique(d,"E");break;case"southeast":case"se":a.pushUnique(d,"SE");break;case"south":case"s":a.pushUnique(d,"S");break;case"southwest":case"sw":a.pushUnique(d,"SW");break;case"west":case"w":a.pushUnique(d,"W");break;case"northwest":case"nw":a.pushUnique(d,"NW");break;case"start":a.pushUnique(d,"start");break;case"center":a.pushUnique(d,"center")}else a.isa(c[e],"num")?d.push(c[e]):a.isa(c[e],"vector")&&d.push(c[e]);return this.collisionPoints=d,d},a}(scrawl);