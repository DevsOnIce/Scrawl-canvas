/*! scrawl-canvas 2015-01-06 */
if(window.scrawl&&window.scrawl.modules&&!window.scrawl.contains(window.scrawl.modules,"stacks"))var scrawl=function(a){"use strict";return a.pageInit=function(){a.getStacks(),a.getCanvases(),a.getElements()},a.getStacks=function(){var b,c,d,e,f,g,h,i;if(f=document.getElementsByClassName("scrawlstack"),g=[],f.length>0){for(b=0,c=f.length;c>b;b++)g.push(f[b]);for(b=0,c=f.length;c>b;b++){for(h=a.newStack({stackElement:g[b]}),d=0,e=a.stk[h.name].children.length;e>d;d++)a.stk[h.name].children[d].style.position="absolute","CANVAS"!==a.stk[h.name].children[d].tagName?a.newElement({domElement:a.stk[h.name].children[d],group:h.name}):a.stk[h.name].children[d].className+=" stack:"+h.name;a.element[h.name]&&(h.group=a.element[h.name].group,delete a.element[h.name],delete a.elm[h.name],a.removeItem(a.elementnames,h.name)),g[b].className.match(/withcanvas/)&&(i=document.createElement("canvas"),i.style.position="absolute",i.id=h.name+"_canvas",i.className="lockTo:"+h.name,a.stk[h.name].appendChild(i))}return!0}return!1},a.getCanvases=function(){var b,c,d,e,f,g,h,i,j;if(d=document.getElementsByTagName("canvas"),j=[],d.length>0){for(b=0,c=d.length;c>b;b++)j.push(d[b]);for(b=0,c=d.length;c>b;b++)f=!1,g=!1,h=!1,-1!==j[b].className.indexOf("stack:")?(f=j[b].className.match(/stack:(\w+)/),f=f[1]):-1!==j[b].className.indexOf("lockTo:")&&(f=j[b].className.match(/lockTo:(\w+)/),f=f[1],h=!0),f&&(a.stack[f]?(a.stk[f].appendChild(j[b]),g=a.stack[f]):(i=document.createElement("div"),i.id=f,j[b].parentElement.appendChild(i),i.appendChild(j[b]),g=a.newStack({stackElement:i}))),e=a.newPad({canvasElement:j[b]}),g&&(e.set({group:g.name,position:"absolute"}),h&&(g.set({canvas:e.name}),e.set({width:"100%",height:"100%",lockTo:g.name}))),0===b&&(a.currentPad=e.name);return!0}return!1},a.getElements=function(){var b,c,d,e,f,g;if(d=document.getElementsByClassName("scrawl"),e=[],d.length>0){for(b=0,c=d.length;c>b;b++)e.push(d[b]);for(b=0,c=d.length;c>b;b++)f=a.xtGet(e.id,e.name,!1),a.contains(a.elementnames,f)||-1!==e[b].className.indexOf("stack:")&&(g=e[b].className.match(/stack:(\w+)/),a.contains(a.stacknames,g[1])&&(a.stk[g[1]].appendChild(e[b]),a.newElement({domElement:e[b],group:g[1]})));return!0}return!1},a.addCanvasToPage=function(b){var c,d,e,f;b=a.safeObject(b),b.width=a.xtGet(b.width,300),b.height=a.xtGet(b.height,150),a.xt(b.stackName)&&(e=a.stack[b.stackName],e||(f=a.xt(b.parentElement)?a.isa(b.parentElement,"str")?document.getElementById(b.parentElement):b.parentElement:document.body,e=a.addStackToPage({stackName:b.stackName,width:b.width,height:b.height,parentElement:f})),b.group=e.name,b.parentElement=e.name),c=document.getElementById(b.parentElement)||document.body,a.isa(b.width,"str")&&(b.width=Math.round(parseFloat(b.width)/100*parseFloat(c.style.width))),a.isa(b.height,"str")&&(b.height=Math.round(parseFloat(b.height)/100*parseFloat(c.style.height))),d=document.createElement("canvas"),d.style.position=a.xtGet(b.position,"absolute"),c.appendChild(d),b.canvasElement=d;var g=new a.Pad(b);return a.setDisplayOffsets(),g},a.addStackToPage=function(b){var c,d;return a.isa(b.stackName,"str")&&a.xt(b.parentElement)?(b.parentElement=a.isa(b.parentElement,"str")?document.getElementById(b.parentElement):b.parentElement,c=document.createElement("div"),c.id=b.stackName,c.style.width=a.xtGet(b.width,300)+"px",c.style.height=a.xtGet(b.height,150)+"px",b.parentElement.appendChild(c),b.stackElement=c,d=a.newStack(b),d.group=a.stack[b.parentElement.id]?b.parentElement.id:"",d):!1},a.setDisplayOffsets=function(b){var c,d;if(b=a.xt(b)?b:"all","stack"===b||"all"===b)for(c=0,d=a.stacknames.length;d>c;c++)a.stack[a.stacknames[c]].setDisplayOffsets();if("pad"===b||"all"===b)for(c=0,d=a.padnames.length;d>c;c++)a.pad[a.padnames[c]].setDisplayOffsets();if("element"===b||"all"===b)for(c=0,d=a.elementnames.length;d>c;c++)a.element[a.elementnames[c]].setDisplayOffsets();return!0},a.render=function(b){var c,d,e;for(a.renderElements(),e=a.xt(b)?[].concat(b):a.padnames,c=0,d=e.length;d>c;c++)a.pad[e[c]].render();return a},a.renderElements=function(){var b,c,d;for(b=0,c=a.stacknames.length;c>b;b++)d=a.stack[a.stacknames[b]],d.group||d.render();return!0},a.update=function(b){var c,d,e;if(b=a.safeObject(b),a.isa(b.group,"str")&&a.group[b.group]&&"ElementGroup"===a.group[b.group].type)a.group[b.group].update(b);else for(c=0,d=a.stacknames.length;d>c;c++)e=a.stack[a.stacknames[c]],e.group||e.update(b);return!0},a.d.PageElement.start={x:0,y:0,z:0},a.d.PageElement.delta={x:0,y:0,z:0},a.d.PageElement.translate={x:0,y:0,z:0},a.d.PageElement.deltaTranslate={x:0,y:0,z:0},a.d.PageElement.handle={x:"center",y:"center",z:0},a.d.PageElement.pivot="",a.d.PageElement.group="",a.d.PageElement.path="",a.d.PageElement.pathPlace=0,a.d.PageElement.deltaPathPlace=0,a.d.PageElement.pathSpeedConstant=!0,a.d.PageElement.pathRoll=0,a.d.PageElement.addPathRoll=!1,a.d.PageElement.lockTo="",a.d.PageElement.lockX=!1,a.d.PageElement.lockY=!1,a.d.PageElement.rotation={n:1,v:{x:0,y:0,z:0}},a.d.PageElement.deltaRotation={n:1,v:{x:0,y:0,z:0}},a.d.PageElement.rotationTolerance=.001,a.d.PageElement.visibility=!0,a.mergeInto(a.d.Pad,a.d.PageElement),a.PageElement.prototype.stacksPageElementConstructor=function(b){var c=a.safeObject(b.start);this.start=a.newVector({name:this.type+"."+this.name+".start",x:a.xtGet(b.startX,c.x,0),y:a.xtGet(b.startY,c.y,0)}),this.correctStart(),this.work.start=a.newVector({name:this.type+"."+this.name+".work.start"}),c=a.safeObject(b.delta),this.delta=a.newVector({name:this.type+"."+this.name+".delta",x:a.xtGet(b.deltaX,c.x,0),y:a.xtGet(b.deltaY,c.y,0)}),this.work.delta=a.newVector({name:this.type+"."+this.name+".work.delta"}),c=a.safeObject(b.handle),this.handle=a.newVector({name:this.type+"."+this.name+".handle",x:a.xtGet(b.handleX,c.x,0),y:a.xtGet(b.handleY,c.y,0)}),this.work.handle=a.newVector({name:this.type+"."+this.name+".work.handle"}),c=a.safeObject(b.translate),this.translate=a.newVector({name:this.type+"."+this.name+".translate",x:a.xtGet(b.translateX,c.x,0),y:a.xtGet(b.translateY,c.y,0),z:a.xtGet(b.translateZ,c.z,0)}),this.work.translate=a.newVector({name:this.type+"."+this.name+".work.translate"}),c=a.safeObject(b.deltaTranslate),this.deltaTranslate=a.newVector({name:this.type+"."+this.name+".deltaTranslate",x:a.xtGet(b.deltaTranslateX,c.x,0),y:a.xtGet(b.deltaTranslateY,c.y,0),z:a.xtGet(b.deltaTranslateZ,c.z,0)}),this.work.deltaTranslate=a.newVector({name:this.type+"."+this.name+".work.deltaTranslate"}),this.pivot=a.xtGet(b.pivot,a.d[this.type].pivot),this.path=a.xtGet(b.path,a.d[this.type].path),this.pathRoll=a.xtGet(b.pathRoll,a.d[this.type].pathRoll),this.addPathRoll=a.xtGet(b.addPathRoll,a.d[this.type].addPathRoll),this.pathSpeedConstant=a.xtGet(b.pathSpeedConstant,a.d[this.type].pathSpeedConstant),this.pathPlace=a.xtGet(b.pathPlace,a.d[this.type].pathPlace),this.deltaPathPlace=a.xtGet(b.deltaPathPlace,a.d[this.type].deltaPathPlace),this.lockX=a.xtGet(b.lockX,a.d[this.type].lockX),this.lockY=a.xtGet(b.lockY,a.d[this.type].lockY),this.lockTo=a.xtGet(b.lockTo,a.d[this.type].lockTo),this.scale=a.xtGet(b.scale,1),this.visibility=a.xtGet(b.visibility,a.d[this.type].visibility),this.rotation=a.newQuaternion({name:this.type+"."+this.name+".rotation"}).setFromEuler({pitch:b.pitch||0,yaw:b.yaw||0,roll:b.roll||0}),this.work.rotation=a.newQuaternion({name:this.type+"."+this.name+".work.rotation"}),this.deltaRotation=a.newQuaternion({name:this.type+"."+this.name+".deltaRotation"}).setFromEuler({pitch:b.deltaPitch||0,yaw:b.deltaYaw||0,roll:b.deltaRoll||0}),this.work.deltaRotation=a.newQuaternion({name:this.type+"."+this.name+".work.deltaRotation"}),this.rotationTolerance=a.xtGet(b.rotationTolerance,a.d[this.type].rotationTolerance),this.group=a.xtGet(b.group,!1),this.group&&a.group[this.group].addElementsToGroup(this.name),this.offset=a.newVector({name:this.type+"."+this.name+".offset"}),this.offset.flag=!1},a.PageElement.prototype.get=function(b){var c,d=["width","height"],e=["startX","startY","handleX","handleY","deltaX","deltaY","translateX","translateY","translateZ"];if(c=this.getElement(),a.contains(d,b))switch(this.type){case"Pad":if("width"===b)return this.width||parseFloat(c.width)||a.d[this.type].width;if("height"===b)return this.height||parseFloat(c.height)||a.d[this.type].height;break;default:if("width"===b)return this.width||parseFloat(c.style.width)||parseFloat(c.clientWidth)||a.d[this.type].width;if("height"===b)return this.height||parseFloat(c.style.height)||parseFloat(c.clientHeight)||a.d[this.type].height}if(a.contains(e,b))switch(b){case"startX":return this.start.x;case"startY":return this.start.y;case"handleX":return this.handle.x;case"handleY":return this.handle.y;case"deltaX":return this.delta.x;case"deltaY":return this.delta.y;case"translateX":return this.translate.x;case"translateY":return this.translate.y;case"translateZ":return this.translate.z}return a.xt(c.style[b])?c.style[b]:a.Base.prototype.get.call(this,b)},a.PageElement.prototype.set=function(b){return b=a.safeObject(b),a.Base.prototype.set.call(this,b),a.xto(b.start,b.startX,b.startY)&&a.Position.prototype.setStart.call(this,b),this.correctStart(),a.xto(b.handle,b.handleX,b.handleY)&&a.Position.prototype.setHandle.call(this,b),a.xto(b.delta,b.deltaX,b.deltaY)&&a.Position.prototype.setDeltaAttribute.call(this,b),a.xto(b.translate,b.translateX,b.translateY,b.translateZ)&&this.setTranslate(b),a.xto(b.deltaTranslate,b.deltaTranslateX,b.deltaTranslateY,b.deltaTranslateZ)&&this.setDeltaTranslate(b),a.xto(b.pitch,b.yaw,b.roll)&&this.setRotation(b),a.xto(b.deltaPitch,b.deltaYaw,b.deltaRoll)&&this.setDeltaRotation(b),a.xto(b.width,b.height,b.scale,b.border,b.borderLeft,b.borderRight,b.borderTop,b.borderBottom,b.borderWidth,b.borderLeftWidth,b.borderRightWidth,b.borderTopWidth,b.borderBottomWidth,b.padding,b.paddingLeft,b.paddingRight,b.paddingTop,b.paddingBottom,b.boxSizing,b.lockTo)&&(a.group[this.group]&&a.group[this.group].checkEqualDimensions()&&(a.group[this.group].recalculateDimensions=!0),this.setLocalDimensions(),this.setDimensions()),a.xto(b.handleX,b.handleY,b.handle,b.width,b.height,b.scale,b.border,b.borderLeft,b.borderRight,b.borderTop,b.borderBottom,b.borderWidth,b.borderLeftWidth,b.borderRightWidth,b.borderTopWidth,b.borderBottomWidth,b.padding,b.paddingLeft,b.paddingRight,b.paddingTop,b.paddingBottom,b.boxSizing,b.lockTo)&&(this.offset.flag=!1),a.xto(b.handleX,b.handleY,b.handle,b.width,b.height,b.scale,b.startX,b.startY,b.start,b.border,b.borderLeft,b.borderRight,b.borderTop,b.borderBottom,b.borderWidth,b.borderLeftWidth,b.borderRightWidth,b.borderTopWidth,b.borderBottomWidth,b.padding,b.paddingLeft,b.paddingRight,b.paddingTop,b.paddingBottom,b.boxSizing,b.lockTo)&&this.setDisplayOffsets(),a.xto(b.handleX,b.handleY,b.handle)&&this.setTransformOrigin(),a.xt(b.mouse)&&this.initMouse({mouse:b.mouse}),a.xt(b.group)&&this.setGroupAttribute(b),a.xt(b.pivot)&&this.setPivotAttribute(b),a.xto(b.title,b.comment)&&this.setAccessibility(b),this.setStyles(b),this},a.PageElement.prototype.setPivotAttribute=function(a){return this.pivot=a.pivot,this.pivot||(delete this.oldX,delete this.oldY),this},a.PageElement.prototype.setGroupAttribute=function(b){var c,d,e;for(d=0,e=a.groupnames.length;e>d;d++)c=a.group[a.groupnames[d]],"ElementGroup"===c.type&&(a.groupnames[d]===b.group?c.addElementsToGroup(this.name):a.contains(c.elements,this.name)&&c.removeElementsFromGroup(this.name));return this},a.PageElement.prototype.setRotation=function(a){return this.rotation.setFromEuler({pitch:a.pitch||0,yaw:a.yaw||0,roll:a.roll||0}),this},a.PageElement.prototype.setDeltaRotation=function(a){return this.deltaRotation.setFromEuler({pitch:a.deltaPitch||0,yaw:a.deltaYaw||0,roll:a.deltaRoll||0}),this},a.PageElement.prototype.setTranslate=function(b){var c;return b=a.safeObject(b),this.translate.type&&"Vector"===this.translate.type||(this.translate=a.newVector(b.translate||this.translate)),c=a.safeObject(b.translate),this.translate.x=a.xtGet(b.translateX,c.x,this.translate.x),this.translate.y=a.xtGet(b.translateY,c.y,this.translate.y),this.translate.z=a.xtGet(b.translateZ,c.z,this.translate.z),this},a.PageElement.prototype.setDeltaTranslate=function(b){var c;return b=a.safeObject(b),this.deltaTranslate.type&&"Vector"===this.deltaTranslate.type||(this.deltaTranslate=a.newVector(b.deltaTranslate||this.deltaTranslate)),c=a.safeObject(b.deltaTranslate),this.deltaTranslate.x=a.xtGet(b.deltaTranslateX,c.x,this.deltaTranslate.x),this.deltaTranslate.y=a.xtGet(b.deltaTranslateY,c.y,this.deltaTranslate.y),this.deltaTranslate.z=a.xtGet(b.deltaTranslateZ,c.z,this.deltaTranslate.z),this},a.PageElement.prototype.correctStart=function(){var b=["left","center","right"],c=["top","center","bottom"];if(a.contains(b,this.start.x))switch(this.start.x){case"left":this.start.x="0%";break;case"center":this.start.x="50%";break;case"right":this.start.x="100%"}if(a.contains(c,this.start.y))switch(this.start.y){case"top":this.start.y="0%";break;case"center":this.start.y="50%";break;case"bottom":this.start.y="100%"}return this},a.PageElement.prototype.setStyles=function(b){var c,d,e,f,g=["hidden","none"],h=["backfaceVisibility","display","width","height","transform","translate","translateX","translateY","translateZ","top","left","bottom","right","zIndex","title","comment"];for(b=a.safeObject(b),c=this.getElement(),d=Object.keys(b),e=0,f=d.length;f>e;e++)"backfaceVisibility"===d[e]?(c.style.webkitBackfaceVisibility=b.backfaceVisibility,c.style.mozBackfaceVisibility=b.backfaceVisibility,c.style.backfaceVisibility=b.backfaceVisibility):"visibility"===d[e]?(this.visibility=a.isa(b.visibility,"str")?a.contains(g,b.visibility)?!1:!0:b.visibility?!0:!1,this.group?c.style.opacity=this.visibility?1:0:c.style.display=this.visibility?"block":"none"):a.contains(h,d[e])||a.xt(c.style[d[e]])&&(c.style[d[e]]=b[d[e]]);return this},a.PageElement.prototype.setDelta=function(b){var c;return a.Position.prototype.setDelta.call(this,b),b=a.safeObject(b),a.xto(b.translate,b.translateX,b.translateY)&&(c=a.safeObject(b.translate),this.translate.x+=a.xtGet(b.translateX,c.x,0),this.translate.y+=a.xtGet(b.translateY,c.y,0),this.translate.z+=a.xtGet(b.translateZ,c.z,0)),a.xto(b.deltaTranslate,b.deltaTranslateX,b.deltaTranslateY)&&(c=a.isa(b.deltaTranslate,"obj")?b.deltaTranslate:{},this.deltaTranslate.x+=a.xtGet(b.deltaTranslateX,c.x,0),this.deltaTranslate.y+=a.xtGet(b.deltaTranslateY,c.y,0),this.deltaTranslate.z+=a.xtGet(tems.deltaTranslateZ,c.z,0)),a.xto(b.pitch,b.yaw,b.roll)&&(c=a.workquat.q1.setFromEuler({pitch:b.pitch||0,yaw:b.yaw||0,roll:b.roll||0}),this.rotation.quaternionMultiply(c)),a.xto(b.deltaPitch,b.deltaYaw,b.deltaRoll)&&(c=a.workquat.q1.setFromEuler({pitch:b.deltaPitch||0,yaw:b.deltaYaw||0,roll:b.deltaRoll||0}),this.deltaRotation.quaternionMultiply(c)),a.xto(b.handleX,b.handleY,b.handle,b.width,b.height,b.scale)&&(this.offset.flag=!1),a.xto(b.handleX,b.handleY,b.handle,b.width,b.height,b.scale,b.startX,b.startY,b.start)&&this.setDisplayOffsets(),a.xto(b.handleX,b.handleY,b.handle)&&this.setTransformOrigin(),a.xto(b.width,b.height,b.scale)&&(a.group[this.group]&&a.group[this.group].checkEqualDimensions()&&(a.group[this.group].recalculateDimensions=!0),this.setLocalDimensions(),this.setDimensions()),this},a.PageElement.prototype.updateStart=function(b){return a.Position.prototype.updateStart.call(this,b),this.setDisplayOffsets(),this},a.PageElement.prototype.revertStart=function(b){return a.Position.prototype.revertStart.call(this,b),this.setDisplayOffsets(),this},a.PageElement.prototype.update3d=function(b){return b=a.safeObject(b),a.isa(b.quaternion,"quaternion")?(this.rotation.set(this.deltaRotation),this.rotation.quaternionRotate(b.quaternion),this.translate.zero(),this.translate.vectorAdd(this.deltaTranslate),this.translate.rotate3d(b.quaternion,b.distance)):(this.rotation.quaternionRotate(this.deltaRotation),this.translate.vectorAdd(this.deltaTranslate)),this},a.PageElement.prototype.reverse=function(b){return a.Position.prototype.reverse.call(this,b),this},a.PageElement.prototype.getPivotOffsetVector=function(){return a.Position.prototype.getPivotOffsetVector.call(this)},a.PageElement.prototype.getStartValues=function(){var b,c,d,e,f;return b=a.v.set(this.start),e=a.group[this.group].stack,e?(f=a.stack[e],c=f.localHeight/this.scale,d=f.localWidth/this.scale):(c=this.localHeight/this.scale,d=this.localWidth/this.scale),a.Position.prototype.calculatePOV.call(this,b,d,c,!1)},a.PageElement.prototype.getOffsetStartVector=function(){return a.Position.prototype.getOffsetStartVector.call(this)},a.PageElement.prototype.renderElement=function(){var b,c,d=[0,0,0,0,0,0,0],e=[0,0,0,0,0];for(b=a.group[this.group],e[0]=this.getElement(),this.offset.flag||(this.offset.set(this.getOffsetStartVector()),this.offset.flag=!0),this.path?(this.setStampUsingPath(),e[1]=this.start):this.pivot?(this.setStampUsingPivot(),e[1]=this.start):e[1]=this.getStartValues(),b&&(b.equalWidth||b.equalHeight)&&this.setDimensions(),this.updateStart(),e[2]=a.isa(this.start.x,"str")?!0:!1,e[3]=a.isa(this.start.y,"str")?!0:!1,1!==this.rotation.getMagnitude()&&this.rotation.normalize(),d[0]=Math.round(this.translate.x*this.scale),d[1]=Math.round(this.translate.y*this.scale),d[2]=Math.round(this.translate.z*this.scale),d[3]=this.rotation.v.x,d[4]=this.rotation.v.y,d[5]=this.rotation.v.z,d[6]=this.rotation.getAngle(!1),c=0;7>c;c++)d[c]<1e-6&&d[c]>-1e-6&&(d[c]=0);return e[4]="translate3d("+d[0]+"px,"+d[1]+"px,"+d[2]+"px) rotate3d("+d[3]+","+d[4]+","+d[5]+","+d[6]+"rad)",e[0].style.webkitTransform=e[4],e[0].style.transform=e[4],e[0].style.zIndex=d[2],e[0].style.left=e[2]?e[1].x*this.scale+this.offset.x+"px":e[1].x+this.offset.x+"px",e[0].style.top=e[3]?e[1].y*this.scale+this.offset.y+"px":e[1].y+this.offset.y+"px",this},a.PageElement.prototype.setStampUsingPath=function(){var b,c;return a.entity[this.path]&&"Path"===a.entity[this.path].type&&(b=a.entity[this.path].getPerimeterPosition(this.pathPlace,this.pathSpeedConstant,this.addPathRoll),this.start.x=this.lockX?this.start.x:b.x,this.start.y=this.lockY?this.start.y:b.y,this.pathRoll=b.r||0,this.addPathRoll&&this.pathRoll&&(c=this.rotation.getEulerAngles(),this.setDelta({roll:this.pathRoll-c.roll}))),this},a.PageElement.prototype.setStampUsingPivot=function(){var b,c,d,e,f;return a.point&&a.point[this.pivot]?(c=a.point[this.pivot],e=a.entity[c.entity],d=c.getCurrentCoordinates().rotate(e.roll).vectorAdd(e.start),this.start.x=this.lockX?this.start.x:d.x,this.start.y=this.lockY?this.start.y:d.y,this):a.entity[this.pivot]?(c=a.entity[this.pivot],d=c.get("Particle"===c.type?"place":"start"),this.start.x=this.lockX?this.start.x:d.x,this.start.y=this.lockY?this.start.y:d.y,this):a.pad[this.pivot]?(this.setStampUsingDomElement(a.pad[this.pivot]),this):a.element[this.pivot]?(this.setStampUsingDomElement(a.element[this.pivot]),this):a.stack[this.pivot]?(this.setStampUsingDomElement(a.stack[this.pivot]),this):("mouse"===this.pivot&&this.group&&(b=a.stack[a.group[this.group].stack].getMouse(),f=this.getStartValues(),a.xta(this.mouseX,this.mouseY)||(this.oldX=f.x,this.oldY=f.y),b.active&&(this.start.x=this.lockX?this.start.x:f.x+b.x-this.oldX,this.start.y=this.lockY?this.start.y:f.y+b.y-this.oldY,this.oldX=b.x,this.oldY=b.y)),this)},a.PageElement.prototype.setStampUsingDomElement=function(a){this.lockTo?this.setStampUsingLockTo(a):this.setStampUsingDomElementPivot(a)},a.PageElement.prototype.setStampUsingDomElementPivot=function(a){var b=a.getStartValues();this.start.x=this.lockX?this.start.x:b.x,this.start.y=this.lockY?this.start.y:b.y},a.PageElement.prototype.setStampUsingLockTo=function(b){var c,d,e,f;if(c=b.getStartValues(),b.offset.flag||(b.offset.set(b.getOffsetStartVector()),b.offset.flag=!0),e=c.x+b.offset.x,f=c.y+b.offset.y,this.lockTo)switch(d=a.group[this.group],this.lockTo){case"bottom":f+=d.equalHeight?d.currentHeight:b.localHeight;break;case"right":e+=d.equalWidth?d.currentWidth:b.localWidth;break;case"left":e-=d.equalWidth?d.currentWidth:b.localWidth;break;case"top":f-=d.equalHeight?d.currentHeight:b.localHeight}this.start.x=e,this.start.y=f},a.PageElement.prototype.setTransformOrigin=function(){var b,c,d,e;return b=this.getElement(),b&&(d=a.isa(this.handle.x,"str")?this.handle.x:this.handle.x*this.scale+"px",e=a.isa(this.handle.y,"str")?this.handle.y:this.handle.y*this.scale+"px",c=d+" "+e,b.style.mozTransformOrigin=c,b.style.webkitTransformOrigin=c,b.style.msTransformOrigin=c,b.style.oTransformOrigin=c,b.style.transformOrigin=c),this},a.PageElement.prototype.setDisplayOffsets=function(){var a,b,c;if(a=0,b=0,c=this.getElement(),c.offsetParent)do a+=c.offsetLeft,b+=c.offsetTop,c=c.offsetParent;while(c.offsetParent);return this.offset.set(this.getOffsetStartVector()),this.offset.flag=!0,this.displayOffsetX=a,this.displayOffsetY=b,this},a.PageElement.prototype.setLocalDimensions=function(){var b,c,d,e,f,g,h;return f=a.xt(a.group[this.group])?a.stack[a.group[this.group].stack]:!1,f&&(c=f.localWidth,b=f.localHeight),g=this.getElement(),g&&(h=window.getComputedStyle(g,null)),e=parseFloat(this.width),0===e||isNaN(e)?g&&(g.style.width="auto",this.localWidth=parseFloat(h.getPropertyValue("width"))):this.localWidth=f&&a.isa(this.width,"str")&&c?parseFloat(this.width)/100*c*this.scale:this.width*this.scale,d=parseFloat(this.height),0===d||isNaN(d)?g&&(g.style.height="auto",this.localHeight=parseFloat(h.getPropertyValue("height"))):this.localHeight=f&&a.isa(this.height,"str")&&b?parseFloat(this.height)/100*b*this.scale:this.height*this.scale,"Pad"===this.type&&this.setCellLocalDimensions(),this},a.PageElement.prototype.setDimensions=function(){var b,c,d,e;return e=this.getElement(),e&&(d=a.group[this.group],c=d&&d.equalWidth?d.currentWidth:this.localWidth,b=d&&d.equalHeight?d.currentHeight:this.localHeight,e.style.width=c+"px",e.style.height=b+"px"),this},a.Pad.prototype.setDimensions=function(){var b,c,d,e;return e=this.getElement(),e&&(d=a.group[this.group],c=d&&d.equalWidth?d.currentWidth:this.localWidth,b=d&&d.equalHeight?d.currentHeight:this.localHeight,e.width=c,e.height=b),this},a.newStack=function(b){return new a.Stack(b)},a.newElement=function(b){return new a.Element(b)},a.newElementGroup=function(b){return new a.ElementGroup(b)},a.pushUnique(a.sectionlist,"stack"),a.pushUnique(a.sectionlist,"stk"),a.pushUnique(a.nameslist,"stacknames"),a.Pad.prototype.padStacksConstructor=function(a){this.setStyles(a),this.setTransformOrigin()},a.Pad.prototype.padStacksSet=function(b){b=a.safeObject(b),this.lockTo&&a.xto(b.width,b.height,b.scale)&&this.setLocalDimensions(),this.group&&(a.canvas[this.name].style.margin="0",a.canvas[this.name].style.boxSizing="border-box")},a.Pad.prototype.setCellLocalDimensions=function(){var b,c,d;if(console.log(this.name,"sCLD",this.localWidth,this.localHeight),a.xt(this.cells))for(b=0,c=this.cells.length;c>b;b++)d=a.cell[this.cells[b]],this.lockTo&&d.name===this.base&&d.set({width:this.localWidth,height:this.localHeight}),d.name===this.display&&d.set({width:this.localWidth,height:this.localHeight})},a.Position.prototype.setStampUsingStacksPivot=function(){var b,c;return b=a.element[this.pivot]||a.stack[this.pivot]||a.pad[this.pivot]||!1,b?(c=b.getStartValues(),this.lockX||(this.start.x=a.isa(b.start.x,"str")?c.x*b.scale:c.x),this.lockY||(this.start.y=a.isa(b.start.y,"str")?c.y*b.scale:c.y),this):void 0},a.Position.prototype.getPivotOffsetVector=function(){var b,c;switch(this.type){case"Block":case"Pad":case"Stack":case"Element":b=this.localHeight/this.scale||this.get("height"),c=this.localWidth/this.scale||this.get("width");break;case"Picture":case"Cell":b=this.pasteData.h/this.scale||this.get("height"),c=this.pasteData.w/this.scale||this.get("width");break;default:b=this.height||this.get("height"),c=this.width||this.get("width")}return a.Position.prototype.calculatePOV.call(this,this.work.handle,c,b,!1)},a.Stack=function(b){var c;return b=a.safeObject(b),a.xt(b.stackElement)?(b.width=a.xtGet(b.width,b.stackElement.style.width,a.d.Stack.width),b.height=a.xtGet(b.height,b.stackElement.style.height,a.d.Stack.height),b.name=a.xtGet(b.stackName,b.name,b.stackElement.id,b.stackElement.name,"Stack"),a.PageElement.call(this,b),this.name.match(/~~~/)&&(this.name=this.name.replace(/~~~/g,"_")),b.stackElement.id=this.name,b.stackElement.style.position="relative",a.stack[this.name]=this,a.stk[this.name]=b.stackElement,a.pushUnique(a.stacknames,this.name),this.setDisplayOffsets(),this.setAccessibility(b),c=a.safeObject(b.perspective),this.perspective=a.newVector({name:this.type+"."+this.name+".perspective",x:a.xtGet(b.perspectiveX,c.x,"center"),y:a.xtGet(b.perspectiveY,c.y,"center"),z:a.xtGet(b.perspectiveZ,c.z,0)}),this.work.perspective=a.newVector({name:this.type+"."+this.name+".work.perspective"}),this.initMouse({mouse:a.isa(b.mouse,"bool")||a.isa(b.mouse,"vector")?b.mouse:!0}),this.groups=[this.name],a.newElementGroup({name:this.name,stack:this.name}),this.group=a.xtGet(b.group,!1),this.group&&a.group[this.group].addElementsToGroup(this.name),this.setStyles(b),this.setPerspective(),this.setTransformOrigin(),this.group&&(a.stk[this.name].style.margin="0",a.stk[this.name].style.boxSizing="border-box"),this):(console.log("Failed to generate a Stack wrapper - no DOM element supplied"),!1)},a.Stack.prototype=Object.create(a.PageElement.prototype),a.Stack.prototype.type="Stack",a.Stack.prototype.classname="stacknames",a.d.Stack={perspective:{x:"center",y:"center",z:0},scaleText:!1,canvas:"",groups:[]},a.mergeInto(a.d.Stack,a.d.PageElement),a.Stack.prototype.getElement=function(){return a.stk[this.name]},a.Stack.prototype.set=function(b){var c,d,e,f;if(b=a.safeObject(b),a.PageElement.prototype.set.call(this,b),a.xto(b.perspective,b.perspectiveX,b.perspectiveY,b.perspectiveZ)&&(this.perspective.type&&"Vector"===this.perspective.type||(this.perspective=a.newVector(b.perspective||this.perspective)),a.xto(b.perspective,b.perspectiveX,b.perspectiveY,b.perspectiveZ)&&(c=a.safeObject(b.perspective),this.perspective.x=a.xtGet(b.perspectiveX,c.x,this.perspective.x),this.perspective.y=a.xtGet(b.perspectiveY,c.y,this.perspective.y),this.perspective.z=a.xtGet(b.perspectiveZ,c.z,this.perspective.z)),this.setPerspective()),a.xto(b.width,b.height,b.scale))for(e=0,f=a.groupnames.length;f>e;e++)d=a.group[a.groupnames[e]],"ElementGroup"===d.type&&d.stack===this.name&&d.updateDimensions();return this},a.Stack.prototype.setDelta=function(b){var c,d,e,f;for(b=a.safeObject(b),a.PageElement.prototype.setDelta.call(this,b),a.xto(b.perspective,b.perspectiveX,b.perspectiveY,b.perspectiveZ)&&(this.perspective.type&&"Vector"===this.perspective.type||(this.perspective=a.newVector(b.perspective||this.perspective)),a.xto(b.perspective,b.perspectiveX,b.perspectiveY,b.perspectiveZ)&&(c=a.safeObject(b.perspective),this.perspective.x+=a.xtGet(b.perspectiveX,c.x,0),this.perspective.y+=a.xtGet(b.perspectiveY,c.y,0),this.perspective.z+=a.xtGet(b.perspectiveZ,c.z,0)),this.setPerspective()),e=0,f=a.groupnames.length;f>e;e++)d=a.group[a.groupnames[e]],"ElementGroup"===d.type&&d.stack===this.name&&d.updateDimensions();return this},a.Stack.prototype.addElementById=function(b){if(a.isa(b,"str")){var c=a.newElement({domElement:document.getElementById(b),group:this.name});return a.stk[this.name].appendChild(a.elm[c.name]),a.elm[c.name]=document.getElementById(c.name),c}return!1},a.Stack.prototype.addElementsByClassName=function(b){var c,d,e,f,g,h=[];if(a.isa(b,"str")){for(c=document.getElementsByClassName(b),f=0,g=c.length;g>f;f++)e=c[f],"CANVAS"!==e.nodeName&&(d=a.newElement({domElement:e,group:this.name}),h.push(d));for(f=0,g=h.length;g>f;f++)a.stk[this.name].appendChild(a.elm[h[f].name]),a.elm[h[f].name]=document.getElementById(h[f].name);return h}return!1},a.Stack.prototype.render=function(){for(var b=0,c=this.groups.length;c>b;b++)a.group[this.groups[b]].render();return!0},a.Stack.prototype.update=function(){for(var b=0,c=this.groups.length;c>b;b++)a.group[this.groups[b]].update();return!0},a.Stack.prototype.parsePerspective=function(){var b,c;return b=this.height||this.get("height"),c=this.width||this.get("width"),a.Position.prototype.calculatePOV.call(this,this.work.perspective,c,b,!1)},a.Stack.prototype.setPerspective=function(){var b,c,d,e;this.resetWork(),b=a.isa(this.perspective.x,"str")?this.scale:1,c=a.isa(this.perspective.y,"str")?this.scale:1,d=this.parsePerspective(),e=this.getElement(),d.x*=b,d.y*=c,d.z*=b,e.style.mozPerspectiveOrigin=d.x+"px "+d.y+"px",e.style.webkitPerspectiveOrigin=d.x+"px "+d.y+"px",e.style.perspectiveOrigin=d.x+"px "+d.y+"px",e.style.mozPerspective=d.z+"px",e.style.webkitPerspective=d.z+"px",e.style.perspective=d.z+"px"},a.pushUnique(a.sectionlist,"element"),a.pushUnique(a.sectionlist,"elm"),a.pushUnique(a.nameslist,"elementnames"),a.Element=function(b){return b=a.safeObject(b),a.xt(b.domElement)?(b.width=a.xtGet(b.width,b.domElement.style.width,a.d.Stack.width),b.height=a.xtGet(b.height,b.domElement.style.height,a.d.Stack.height),b.name=a.xtGet(b.elementName,b.name,b.domElement.id,b.domElement.name,"Element"),a.PageElement.call(this,b),this.name.match(/~~~/)&&(this.name=this.name.replace(/~~~/g,"_")),b.domElement.id=this.name,b.domElement.style.position="absolute",a.element[this.name]=this,a.elm[this.name]=b.domElement,a.pushUnique(a.elementnames,this.name),this.setDisplayOffsets(),this.initMouse({mouse:a.isa(b.mouse,"bool")||a.isa(b.mouse,"vector")?b.mouse:!0}),this.setStyles(b),this.setTransformOrigin(),this.group&&(a.elm[this.name].style.margin="0",a.elm[this.name].style.boxSizing="border-box"),this):(console.log("Failed to generate an Element wrapper - no DOM element supplied"),!1)},a.Element.prototype=Object.create(a.PageElement.prototype),a.Element.prototype.type="Element",a.Element.prototype.classname="elementnames",a.d.Element={height:"auto"},a.mergeInto(a.d.Element,a.d.PageElement),a.Element.prototype.getElement=function(){return a.elm[this.name]},a.ElementGroup=function(b){return b=a.safeObject(b),a.Base.call(this,b),this.entitys=a.xt(b.entitys)?[].concat(b.entitys):[],this.elements=a.xt(b.elements)?[].concat(b.elements):[],this.stack=b.stack||!1,this.equalWidth=a.xtGet(b.equalWidth,!1),this.equalHeight=a.xtGet(b.equalHeight,!1),this.currentWidth=0,this.currentHeight=0,this.stack&&a.pushUnique(a.stack[this.stack].groups,this.name),a.group[this.name]=this,a.pushUnique(a.groupnames,this.name),this},a.ElementGroup.prototype=Object.create(a.Base.prototype),a.ElementGroup.prototype.type="ElementGroup",a.ElementGroup.prototype.classname="groupnames",a.d.ElementGroup={entitys:[],elements:[],currentWidth:!1,currentHeight:!1,equalWidth:!1,equalHeight:!1,recalculateDimensions:!1,stack:""},a.mergeInto(a.d.ElementGroup,a.d.Base),a.ElementGroup.prototype.stamp=function(){var b,c,d;for(d=a.stack[this.stack],b=0,c=this.entitys.length;c>b;b++)a.entity[this.entitys[b]].stamp("none",d);return this},a.ElementGroup.prototype.render=function(){var b,c,d;if(this.recalculateDimensions){for(b=0,c=this.elements.length;c>b;b++)d=a.stack[this.elements[b]]||a.pad[this.elements[b]]||a.element[this.elements[b]]||!1,d.setLocalDimensions();this.recalculateDimensions=!1}if(this.checkEqualDimensions())for(this.currentWidth=0,this.currentHeight=0,b=0,c=this.elements.length;c>b;b++)d=a.stack[this.elements[b]]||a.pad[this.elements[b]]||a.element[this.elements[b]]||!1,d.localWidth>this.currentWidth&&(this.currentWidth=d.localWidth),d.localHeight>this.currentHeight&&(this.currentHeight=d.localHeight);for(b=0,c=this.elements.length;c>b;b++)d=a.stack[this.elements[b]]||a.pad[this.elements[b]]||a.element[this.elements[b]]||!1,d.renderElement(),"Stack"===d.type&&a.group[d.name].render();return this},a.ElementGroup.prototype.update=function(b){var c,d,e;for(c=0,d=this.elements.length;d>c;c++)e=a.stack[this.elements[c]]||a.pad[this.elements[c]]||a.element[this.elements[c]]||!1,e.update3d(b),"Stack"===e.type&&a.group[e.name].update(b);return this},a.ElementGroup.prototype.checkEqualDimensions=function(){return this.equalHeight||this.equalWidth?!0:!1},a.ElementGroup.prototype.addElementsToGroup=function(b){var c,d;
for(b=a.xt(b)?[].concat(b):[],c=0,d=b.length;d>c;c++)a.pushUnique(this.elements,b[c]);return this},a.ElementGroup.prototype.removeElementsFromGroup=function(b){var c,d;for(b=a.xt(b)?[].concat(b):[],c=0,d=b.length;d>c;c++)a.removeItem(this.elements,b[c]);return this},a.ElementGroup.prototype.addEntitysToGroup=function(b){var c,d;for(b=a.xt(b)?[].concat(b):[],c=0,d=b.length;d>c;c++)a.pushUnique(this.entitys,b[c]);return this},a.ElementGroup.prototype.removeEntitysFromGroup=function(b){var c,d;for(b=a.xt(b)?[].concat(b):[],c=0,d=b.length;d>c;c++)a.removeItem(this.entitys,b[c]);return this},a.ElementGroup.prototype.updateElementsBy=function(b){var c,d,e;for(b=a.safeObject(b),c=0,d=this.elements.length;d>c;c++)e=a.stack[this.elements[c]]||a.pad[this.elements[c]]||a.element[this.elements[c]]||!1,e.setDelta(b);return this},a.ElementGroup.prototype.updateEntitysBy=function(b){var c,d;for(b=a.safeObject(b),c=0,d=this.entitys.length;d>c;c++)a.entity[this.entitys[c]].setDelta(b);return this},a.ElementGroup.prototype.updateBy=function(a){return this.updateElementsBy(a),this.updateEntitysBy(a),this},a.ElementGroup.prototype.setElementsTo=function(b){var c,d,e;for(c=0,d=this.elements.length;d>c;c++)e=a.stack[this.elements[c]]||a.pad[this.elements[c]]||a.element[this.elements[c]]||!1,e.set(b);return this},a.ElementGroup.prototype.updateDimensions=function(){var b,c,d;for(b=0,c=this.elements.length;c>b;b++)d=a.stack[this.elements[b]]||a.pad[this.elements[b]]||a.element[this.elements[b]]||!1,d.setLocalDimensions(),d.setDimensions(),d.offset.flag=!1,"Stack"===d.type&&a.group[d.name].updateDimensions();return this},a.ElementGroup.prototype.setEntitysTo=function(b){for(var c=0,d=this.entitys.length;d>c;c++)a.entity[this.entitys[c]].set(b);return this},a.ElementGroup.prototype.setTo=function(a){return this.setElementsTo(a),this.setEntitysTo(a),this},a.ElementGroup.prototype.pivotElementsTo=function(b){var c,d,e,f,g,h,i={pivot:"",handleX:0,handleY:0};if(b=a.isa(b,"str")?b:!1,b&&(e=a.stack[b]||a.pad[b]||a.element[b]||a.entity[b]||a.point[b]||!1))for(f="Point"===e.type?e.local:e.start,c=0,d=this.elements.length;d>c;c++)g=a.stack[this.elements[c]]||a.pad[this.elements[c]]||a.element[this.elements[c]]||!1,g&&(h=a.v.set(g.start),h.vectorSubtract(f),i.pivot=b,i.handleX=-h.x,i.handleY=-h.y,g.set(i));return this},a}(scrawl);