/*! scrawl-canvas 2015-06-28 */
if(window.scrawl&&window.scrawl.modules&&!window.scrawl.contains(window.scrawl.modules,"phrase"))var scrawl=function(a){"use strict";return a.newPhrase=function(b){return a.makePhrase(b)},a.makePhrase=function(b){return new a.Phrase(b)},a.pushUnique(a.sectionlist,"text"),a.pushUnique(a.nameslist,"textnames"),a.Phrase=function(b){return b=a.safeObject(b),a.Entity.call(this,b),a.Position.prototype.set.call(this,b),this.registerInLibrary(),this.texts=[],this.lineHeight=a.xtGet(b.lineHeight,a.d.Phrase.lineHeight),b.font&&this.checkFont(b.font),this.constructFont(),this.size=this.get("size"),this.multiline(b),this.getMetrics(),this},a.Phrase.prototype=Object.create(a.Entity.prototype),a.Phrase.prototype.type="Phrase",a.Phrase.prototype.classname="entitynames",a.d.Phrase={text:"",style:"normal",variant:"normal",weight:"normal",size:12,metrics:"pt",family:"sans-serif",lineHeight:1.5,backgroundColor:"",backgroundMargin:0,textAlongPath:"phrase",fixedWidth:!1,texts:[]},a.mergeInto(a.d.Phrase,a.d.Entity),a.Phrase.prototype.set=function(b){return a.Entity.prototype.set.call(this,b),b=a.safeObject(b),this.lineHeight=a.xtGet(b.lineHeight,this.lineHeight),b.font&&(this.checkFont(b.font),this.offset.flag=!1),(b.text||b.size||b.scale)&&(this.offset.flag=!1),this.constructFont(),this.size=this.get("size"),this.multiline(b),this.getMetrics(),this},a.Phrase.prototype.setDelta=function(b){return a.Entity.prototype.setDelta.call(this,b),b.text&&(this.offset.flag=!1),(b.size||b.scale)&&(this.constructFont(),this.offset.flag=!1),this.getMetrics(),this},a.Phrase.prototype.clone=function(b){return b.texts=[],a.Entity.prototype.clone.call(this,b)},a.Phrase.prototype.multiline=function(b){var c,d,e,f,g,h;if(b=JSON.parse(JSON.stringify(b)),c=""+(b.text||this.get("text")),d=c.split("\n"),a.xt(this.texts))for(e=0,f=this.texts.length;f>e;e++)delete a.text[this.texts[e]],a.removeItem(a.textnames,this.texts[e]);for(this.texts.length=0,b.phrase=this.name,g=0,h=d.length;h>g;g++)b.text=d[g],b.text.length>0&&new a.Text(b);return this.text=c,this},a.Phrase.prototype.checkFont=function(b){return a.xt(b)&&this.deconstructFont(),this.constructFont(),this},a.Phrase.prototype.deconstructFont=function(){var b,c,d,e,f,g,h,i,j,k,l,m=[],n=[100,200,300,400,500,600,700,800,900,"italic","oblique","small-caps","bold","bolder","lighter","xx-small","x-small","small","medium","large","x-large","xx-large"],o={style:"",variant:"",weight:"",size:0,metrics:"",family:""};for(d=a.ctx[this.context].font,g=this.get("style"),h=this.get("variant"),i=this.get("weight"),j=this.get("size"),k=this.get("metrics"),l=this.get("family"),g=/italic/i.test(d)?"italic":/oblique/i.test(d)?"oblique":"normal",h=/small-caps/i.test(d)?"small-caps":"normal",/bold/i.test(d)?i="bold":/bolder/i.test(d)?i="bolder":/lighter/i.test(d)?i="lighter":/([1-9]00)/i.test(d)?(m=d.match(/([1-9]00)/i),i=m[1]):i="normal",m.length=0,/(\d+)(%|in|cm|mm|em|ex|pt|pc|ex)?/i.test(d)?(m=d.match(/(\d+)(%|in|cm|mm|em|ex|pt|pc|ex|px)/i),j=parseFloat(m[1]),k=m[2]):/xx-small/i.test(d)?(j=3,k="pt"):/x-small/i.test(d)?(j=6,k="pt"):/small/i.test(d)?(j=9,k="pt"):/medium/i.test(d)?(j=12,k="pt"):/large/i.test(d)?(j=15,k="pt"):/x-large/i.test(d)?(j=18,k="pt"):/xx-large/i.test(d)?(j=21,k="pt"):(j=12,k="pt"),e="",f=d.split(" "),b=0,c=f.length;c>b;b++)a.contains(n,f[b])||f[b].match(/[^\/](\d)+(%|in|cm|mm|em|ex|pt|pc|ex)?/i)||(e+=f[b]+" ");return e||(e="Verdana, Geneva, sans-serif"),l=e,o.style=g,o.variant=h,o.weight=i,o.size=j,o.metrics=k,o.family=l,this.set(o),this},a.Phrase.prototype.constructFont=function(){var b,c,d,e,f,g,h;return b="",c=this.get("style"),d=this.get("variant"),e=this.get("weight"),f=this.get("size"),g=this.get("metrics"),h=this.get("family"),"normal"!==c&&(b+=c+" "),"normal"!==d&&(b+=d+" "),"normal"!==e&&(b+=e+" "),b+=f*this.scale+g+" ",b+=h,a.ctx[this.context].font=b,this},a.Phrase.prototype.stamp=function(b,c){var d;return this.visibility&&(d=a.entity[this.path]&&"Path"===a.entity[this.path].type,this.pivot||!d||"phrase"===this.get("textAlongPath")?a.Entity.prototype.stamp.call(this,b,c):(a.text[this.texts[0]].stampAlongPath(b,c),this.stampFilter(a.context[c],c))),this},a.Phrase.prototype.clear=function(b,c){var d,e,f,g,h=this.getOffset(),i=this.prepareStamp(),j=this.size*this.lineHeight*this.scale;for(a.cell[c].setEngine(this),b.globalCompositeOperation="destination-out",this.rotateCell(b,c),f=i.x+h.x,d=0,e=this.texts.length;e>d;d++)g=i.y+j*d+h.y,a.text[this.texts[d]].clear(b,c,f,g);return b.globalCompositeOperation=a.ctx[c].get("globalCompositeOperation"),this},a.Phrase.prototype.clearWithBackground=function(b,c){var d,e,f,g,h=this.getOffset(),i=this.prepareStamp(),j=this.size*this.lineHeight*this.scale;for(a.cell[c].setEngine(this),this.rotateCell(b,c),f=i.x+h.x,d=0,e=this.texts.length;e>d;d++)g=i.y+j*d+h.y,a.text[this.texts[d]].clearWithBackground(b,c,f,g);return this},a.Phrase.prototype.draw=function(b,c){var d,e,f,g,h=this.getOffset(),i=this.prepareStamp(),j=this.size*this.lineHeight*this.scale;for(a.cell[c].setEngine(this),this.rotateCell(b,c),a.xt(this.backgroundColor)&&this.addBackgroundColor(b,i),f=i.x+h.x,d=0,e=this.texts.length;e>d;d++)g=i.y+j*d+h.y,a.text[this.texts[d]].draw(b,c,f,g);return this},a.Phrase.prototype.fill=function(b,c){var d,e,f,g,h=this.getOffset(),i=this.prepareStamp(),j=this.size*this.lineHeight*this.scale;for(a.cell[c].setEngine(this),this.rotateCell(b,c),a.xt(this.backgroundColor)&&this.addBackgroundColor(b,i),f=i.x+h.x,d=0,e=this.texts.length;e>d;d++)g=i.y+j*d+h.y,a.text[this.texts[d]].fill(b,c,f,g);return this},a.Phrase.prototype.drawFill=function(b,c){var d,e,f,g,h=this.getOffset(),i=this.prepareStamp(),j=this.size*this.lineHeight*this.scale;for(a.cell[c].setEngine(this),this.rotateCell(b,c),a.xt(this.backgroundColor)&&this.addBackgroundColor(b,i),f=i.x+h.x,d=0,e=this.texts.length;e>d;d++)g=i.y+j*d+h.y,a.text[this.texts[d]].drawFill(b,c,f,g,this);return this},a.Phrase.prototype.fillDraw=function(b,c){var d,e,f,g,h=this.getOffset(),i=this.prepareStamp(),j=this.size*this.lineHeight*this.scale;for(a.cell[c].setEngine(this),this.rotateCell(b,c),a.xt(this.backgroundColor)&&this.addBackgroundColor(b,i),f=i.x+h.x,d=0,e=this.texts.length;e>d;d++)g=i.y+j*d+h.y,a.text[this.texts[d]].fillDraw(b,c,f,g,this);return this},a.Phrase.prototype.sinkInto=function(b,c){var d,e,f,g,h=this.getOffset(),i=this.prepareStamp(),j=this.size*this.lineHeight*this.scale;for(a.cell[c].setEngine(this),this.rotateCell(b,c),a.xt(this.backgroundColor)&&this.addBackgroundColor(b,i),f=i.x+h.x,d=0,e=this.texts.length;e>d;d++)g=i.y+j*d+h.y,a.text[this.texts[d]].sinkInto(b,c,f,g);return this},a.Phrase.prototype.floatOver=function(b,c){var d,e,f,g,h=this.getOffset(),i=this.prepareStamp(),j=this.size*this.lineHeight*this.scale;for(a.cell[c].setEngine(this),this.rotateCell(b,c),a.xt(this.backgroundColor)&&addBackgroundColor(b,i),f=i.x+h.x,d=0,e=this.texts.length;e>d;d++)g=i.y+j*d+h.y,a.text[this.texts[d]].floatOver(b,c,f,g);return this},a.Phrase.prototype.none=function(){return this.prepareStamp(),this},a.Phrase.prototype.getMetrics=function(){var b,c,d,e;for(d=0,e=0,b=0,c=this.texts.length;c>b;b++)e=a.text[this.texts[b]].get("width")>e?a.text[this.texts[b]].width:e,d+=a.text[this.texts[b]].get("height");return this.width=e,this.height=d,this},a.Phrase.prototype.addBackgroundColor=function(b,c){var d,e,f,g,h;return f=this.get("backgroundMargin"),g=c.x-f,h=c.y-f,e=this.width*this.scale+2*f,d=this.height*this.scale+2*f,b.fillStyle=this.backgroundColor,b.fillRect(g,h,e,d),b.fillStyle=a.ctx[this.context].get("fillStyle"),this},a.Phrase.prototype.getOffset=function(){var b,c,d,e={x:0,y:0};switch(d=a.ctx[this.context],b=0,c=0,d.get("textAlign")){case"start":case"left":b=0;break;case"center":b=this.width/2*this.scale;break;case"right":case"end":b=this.width*this.scale}switch(d.get("textBaseline")){case"top":c=0;break;case"hanging":c=this.size*this.lineHeight*this.scale*.1;break;case"middle":c=this.size*this.lineHeight*this.scale*.5;break;case"bottom":c=this.size*this.lineHeight*this.scale;break;default:c=this.size*this.lineHeight*this.scale*.85}return e.x=b,e.y=c,e},a.Text=function(b){return b=a.safeObject(b),a.Base.call(this,b),this.text=a.xtGet(b.text,a.d.Text.text),this.phrase=a.xtGet(b.phrase,a.d.Text.phrase),this.context=a.entity[this.phrase].context,this.fixedWidth=a.xtGet(b.fixedWidth,a.d.Text.fixedWidth),this.textAlongPath=a.xtGet(b.textAlongPath,a.d.Text.textAlongPath),this.glyphs=[],this.glyphWidths=[],a.text[this.name]=this,a.pushUnique(a.textnames,this.name),a.pushUnique(a.entity[this.phrase].texts,this.name),this.getMetrics(),this},a.Text.prototype=Object.create(a.Base.prototype),a.Text.prototype.type="Text",a.Text.prototype.classname="textnames",a.d.Text={text:"",phrase:"",context:"",fixedWidth:!1,textAlongPath:"phrase",width:0,height:0,glyphs:[],glyphWidths:[]},a.mergeInto(a.d.Text,a.d.Base),a.Text.prototype.stampAlongPath=function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q;for(d=a.entity[this.phrase],b=a.isa(b,"str")?b:d.method,c=a.isa(c,"str")&&a.cell[c]?c:a.cell[a.group[d.group].cell],e=a.context[c],c=a.cell[c],g=a.entity[d.path].getPerimeterLength(),h=this.width*d.scale,i=h/g,j=d.pathPlace,l=this.text,0===this.glyphs.length&&this.getMetrics(),c.setEngine(d),p=0,q=this.glyphs.length;q>p;p++)if(a.xt(this.glyphs[p])){switch(this.text=this.glyphs[p],k=j+this.glyphWidths[p]/2/h*i,a.isBetween(k,0,1,!0)||(k+=k>.5?-1:1),f=a.entity[d.path].getPerimeterPosition(k,d.pathSpeedConstant,!0),m=f.x,n=f.y,o=f.r*a.radian,e.setTransform(1,0,0,1,0,0),e.translate(m,n),e.rotate(o),e.translate(-m,-n),b){case"draw":this.draw(e,c,m,n);break;case"fill":this.fill(e,c,m,n);break;case"drawFill":this.drawFill(e,c,m,n,d);break;case"fillDraw":this.fillDraw(e,c,m,n,d);break;case"sinkInto":this.sinkInto(e,c,m,n);break;case"floatOver":this.floatOver(e,c,m,n)}j+=this.glyphWidths[p]/h*i,a.isBetween(j,0,1,!0)||(j+=j>.5?-1:1)}return this.text=l,this},a.Text.prototype.clipAlongPath=function(){var b,c,d,e,f,g,h,i,j,k,l,m,n;for(b=a.entity[this.phrase],d=a.entity[b.path].getPerimeterLength(),e=this.width*b.scale,f=e/d,g=b.pathPlace,i=this.text,0===this.glyphs.length&&this.getMetrics(),m=0,n=this.glyphs.length;n>m;m++)a.xt(this.glyphs[m])&&(this.text=this.glyphs[m],h=g+this.glyphWidths[m]/2/e*f,a.isBetween(h,0,1,!0)||(h+=h>.5?-1:1),c=a.entity[b.path].getPerimeterPosition(h,b.pathSpeedConstant,!0),j=c.x,k=c.y,l=c.r*a.radian,a.cvx.setTransform(1,0,0,1,0,0),a.cvx.translate(j,k),a.cvx.rotate(l),a.cvx.translate(-j,-k),a.cvx.fillText(this.text,j,k),g+=this.glyphWidths[m]/e*f,a.isBetween(g,0,1,!0)||(g+=g>.5?-1:1));return this.text=i,this},a.Text.prototype.clear=function(a,b,c,d){return a.fillText(this.text,c,d),this},a.Text.prototype.clearWithBackground=function(b,c,d,e){return b.fillStyle=a.cell[c].backgroundColor,b.globalAlpha=1,b.fillText(this.text,d,e),b.fillStyle=a.ctx[c].fillStyle,b.globalAlpha=a.ctx[c].globalAlpha,this},a.Text.prototype.draw=function(a,b,c,d){return a.strokeText(this.text,c,d),this},a.Text.prototype.fill=function(a,b,c,d){return a.fillText(this.text,c,d),this},a.Text.prototype.drawFill=function(a,b,c,d,e){return a.strokeText(this.text,c,d),e.clearShadow(a,b),a.fillText(this.text,c,d),e.restoreShadow(a,b),this},a.Text.prototype.fillDraw=function(a,b,c,d,e){return a.fillText(this.text,c,d),e.clearShadow(a,b),a.strokeText(this.text,c,d),e.restoreShadow(a,b),this},a.Text.prototype.sinkInto=function(a,b,c,d){return a.fillText(this.text,c,d),a.strokeText(this.text,c,d),this},a.Text.prototype.floatOver=function(a,b,c,d){return a.strokeText(this.text,c,d),a.fillText(this.text,c,d),this},a.Text.prototype.clip=function(){return this},a.Text.prototype.getMetrics=function(){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;if(b=a.entity[this.phrase],c=a.context[a.pad[a.currentPad].current],d=a.ctx[this.context],e=c.font,f=c.textBaseline,g=c.textAlign,c.font=d.get("font"),c.textBaseline=d.get("textBaseline"),c.textAlign=d.get("textAlign"),this.width=c.measureText(this.text).width/b.scale,this.height=b.size*b.lineHeight,b.path)if(this.glyphs.length=0,this.glyphWidths.length=0,h=this.text,"word"===this.textAlongPath)for(j=this.text.split(" "),k=0,l=j.length;l>k;k++)this.glyphs.push(j[k]),this.glyphWidths.push(c.measureText(j[k]).width),a.xt(j[k+1])&&(this.glyphs.push(" "),this.glyphWidths.push(c.measureText(" ").width));else if(i=c.measureText(h).width,this.fixedWidth)for(m=0,n=h.length;n>m;m++)this.glyphs.push(h[m]),this.glyphWidths.push(i/n);else for(o=1,p=h.length;p>=o;o++)this.glyphs.push(h[o-1]),j=h.substr(0,o-1)+h.substr(o),this.glyphWidths.push(i-c.measureText(j).width);return c.font=e,c.textBaseline=f,c.textAlign=g,this},a}(scrawl);