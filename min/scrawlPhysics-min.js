/*! scrawl-canvas 2015-05-04 */
if(window.scrawl&&window.scrawl.modules&&!window.scrawl.contains(window.scrawl.modules,"physics"))var scrawl=function(a){"use strict";return a.physics={gravity:9.8,airDensity:1.23,deltaTime:0},a.workphys={v1:a.makeVector(),v2:a.makeVector(),v3:a.makeVector(),v4:a.makeVector(),v5:a.makeVector()},a.updateSprings=function(b){var c,d,e,f,g=[];if(a.springnames.length>0){for(b=a.isa(b,"arr")?b:a.springnames,c=0,d=b.length;d>c;c++)g.push(a.isa(b[c],"obj")?b[c]:a.isa(b[c],"str")?a.spring[b[c]]:!1);for(e=0,f=g.length;f>e;e++)g[e]&&g[e].update();return!0}return!1},a.physicsInit=function(){a.makeForce({name:"gravity",fn:function(b){b.load.vectorAdd({y:b.mass*a.physics.gravity})}}),a.makeForce({name:"drag",fn:function(b){var c,d,e;b.resetWork(),c=b.work.velocity.reverse().normalize(),d=b.velocity.getMagnitude(),e=.5*a.physics.airDensity*d*d*b.get("area")*b.get("drag"),c.scalarMultiply(e),b.load.vectorAdd(c)}})},a.newParticle=function(b){return a.makeParticle(b)},a.newSpring=function(b){return a.makeSpring(b)},a.newForce=function(b){return a.makeForce(b)},a.makeParticle=function(b){return new a.Particle(b)},a.makeSpring=function(b){return new a.Spring(b)},a.makeForce=function(b){return new a.Force(b)},a.Particle=function(b){return a.Base.call(this,b),b=a.safeObject(b),this.place=a.makeVector(),this.work.place=a.makeVector(),this.velocity=a.makeVector(),this.work.velocity=a.makeVector(),this.set(b),this.priorPlace=a.makeVector(this.place),this.engine=b.engine||"euler",this.userVar=b.userVar||{},this.mobile=a.isa(b.mobile,"bool")?b.mobile:!0,this.forces=b.forces||[],this.springs=b.springs||[],this.mass=b.mass||a.d.Particle.mass,this.elasticity=b.elasticity||a.d.Particle.elasticity,this.radius=b.radius||a.d.Particle.radius,(b.radius||b.area)&&(this.area=b.area||2*Math.PI*this.get("radius")*this.get("radius")||a.d.Particle.area),this.load=a.makeVector(),a.entity[this.name]=this,a.pushUnique(a.entitynames,this.name),this.group=a.Entity.prototype.getGroup.call(this,b),a.group[this.group].addEntitysToGroup(this.name),this},a.Particle.prototype=Object.create(a.Base.prototype),a.Particle.prototype.type="Particle",a.Particle.prototype.classname="entitynames",a.Particle.prototype.order=0,a.d.Particle={group:"",order:0,mobile:!0,mass:1,radius:.1,area:.03,drag:.42,elasticity:1,userVar:{},place:{x:0,y:0,z:0},velocity:{x:0,y:0,z:0},engine:"euler",forces:[],springs:[],load:a.makeVector()},a.mergeInto(a.d.Particle,a.d.Scrawl),a.Particle.prototype.set=function(b){var c;return b=a.safeObject(b),a.Base.prototype.set.call(this,b),this.place.type&&"Vector"===this.place.type||(this.place=a.makeVector(b.place||this.place)),a.xto(b.start,b.startX,b.startY)&&(c=a.safeObject(b.start),this.place.x=a.xtGet(b.startX,c.x,this.place.x),this.place.y=a.xtGet(b.startY,c.y,this.place.y)),this.velocity.type&&"Vector"===this.velocity.type||(this.velocity=a.makeVector(b.velocity||this.velocity)),a.xto(b.delta,b.deltaX,b.deltaY,b.velocity)&&(c=a.safeObject(b.delta),this.velocity.x=a.xtGet(b.deltaX,c.x,this.velocity.x),this.velocity.y=a.xtGet(b.deltaY,c.y,this.velocity.y)),this},a.Particle.prototype.clone=function(b){var c,d,e;for(c=a.Base.prototype.clone.call(this,b),c.place=a.makeVector(c.place),c.velocity=a.makeVector(c.velocity),c.forces=[],d=0,e=this.forces.length;e>d;d++)c.forces.push(this.forces[d]);return c},a.Particle.prototype.addForce=function(b){return a.xt(b)&&this.forces.push(b),this},a.Particle.prototype.revert=function(){return this.place.set(this.priorPlace),this},a.Particle.prototype.stamp=function(){if(this.mobile)switch(this.calculateLoads(),this.engine){case"improvedEuler":this.updateImprovedEuler();break;case"rungeKutter":this.updateRungeKutter();break;default:this.updateEuler()}return this},a.Particle.prototype.forceStamp=function(){return this.stamp()},a.Particle.prototype.update=function(){return this.stamp()},a.Particle.prototype.calculateLoads=function(){var b,c;for(this.load.zero(),b=0,c=this.forces.length;c>b;b++)a.isa(this.forces[b],"str")&&a.force[this.forces[b]]?a.force[this.forces[b]].run(this):this.forces[b](this);for(b=0,c=this.springs.length;c>b;b++)a.spring[this.springs[b]].start===this.name?this.load.vectorAdd(a.spring[this.springs[b]].force):a.spring[this.springs[b]].end===this.name&&this.load.vectorSubtract(a.spring[this.springs[b]].force);return this},a.Particle.prototype.updateEuler=function(){return this.resetWork(),a.workphys.v1.set(this.load).scalarDivide(this.mass).scalarMultiply(a.physics.deltaTime),this.work.velocity.vectorAdd(a.workphys.v1),this.velocity.set(this.work.velocity),this.priorPlace.set(this.place),this.place.vectorAdd(this.work.velocity.scalarMultiply(a.physics.deltaTime)),this},a.Particle.prototype.updateImprovedEuler=function(){var b,c,d;return this.resetWork(),b=a.workphys.v1.set(this.load).scalarDivide(this.mass).scalarMultiply(a.physics.deltaTime),c=a.workphys.v2.set(this.load).vectorAdd(b).scalarDivide(this.mass).scalarMultiply(a.physics.deltaTime),d=b.vectorAdd(c).scalarDivide(2),this.work.velocity.vectorAdd(d),this.velocity.set(this.work.velocity),this.priorPlace.set(this.place),this.place.vectorAdd(this.work.velocity.scalarMultiply(a.physics.deltaTime)),this},a.Particle.prototype.updateRungeKutter=function(){var b,c,d,e,f;return this.resetWork(),b=a.workphys.v1.set(this.load).scalarDivide(this.mass).scalarMultiply(a.physics.deltaTime).scalarDivide(2),c=a.workphys.v2.set(this.load).vectorAdd(b).scalarDivide(this.mass).scalarMultiply(a.physics.deltaTime).scalarDivide(2),d=a.workphys.v3.set(this.load).vectorAdd(c).scalarDivide(this.mass).scalarMultiply(a.physics.deltaTime),e=a.workphys.v4.set(this.load).vectorAdd(d).scalarDivide(this.mass).scalarMultiply(a.physics.deltaTime),f=a.workphys.v5,c.scalarMultiply(2),d.scalarMultiply(2),f.set(b).vectorAdd(c).vectorAdd(d).vectorAdd(e).scalarDivide(6),this.work.velocity.vectorAdd(f),this.velocity.set(this.work.velocity),this.priorPlace.set(this.place),this.place.vectorAdd(this.work.velocity.scalarMultiply(a.physics.deltaTime)),this},a.Particle.prototype.linearCollide=function(b){var c,d,e,f;return this.resetWork(),c=a.workphys.v1.set(this.place).vectorSubtract(b.place).normalize(),d=a.workphys.v2.set(this.velocity).vectorSubtract(b.velocity),e=d.getDotProduct(c),f=a.workphys.v3,e=-e*(1+(this.elasticity+b.elasticity)/2),e/=1/this.mass+1/b.mass,f.set(c).scalarMultiply(e),this.velocity.vectorAdd(f.scalarDivide(this.mass)),b.velocity.vectorAdd(f.scalarDivide(b.mass).reverse()),this},a.Particle.prototype.addSpring=function(b){var c,d,e={start:null,end:null};return a.isa(b,"str")&&a.entity[b]?(d=b,e.start=this.name,e.end=b,c=a.makeSpring(e)):(b=a.safeObject(b),d=b.end||!1,d&&a.entity[d]&&(b.start=this.name,c=a.makeSpring(b))),c&&(a.pushUnique(this.springs,c.name),a.pushUnique(a.entity[d].springs,c.name)),this},a.Particle.prototype.removeSprings=function(){var b,c,d;for(d=this.springs.slice(0),b=0,c=d.length;c>b;b++)a.spring[d[b]].kill();return this},a.Particle.prototype.removeSpringsTo=function(b){var c,d,e,f=[];if(a.xt(b)&&a.entity[b]){for(c=0,d=this.springs.length;d>c;c++)e=a.spring[this.springs[c]],(e.start===this.name||e.end===this.name)&&f.push(this.springs[c]);for(c=0,d=f.length;d>c;c++)a.spring[f[c]].kill()}return this},a.Particle.prototype.pickupEntity=function(){return this},a.Particle.prototype.dropEntity=function(){return this},a.Particle.prototype.updateStart=function(){return this},a.pushUnique(a.sectionlist,"spring"),a.pushUnique(a.nameslist,"springnames"),a.Spring=function(b){var c,d,e;return b=a.safeObject(b),a.xta(b.start,b.end)?(c=a.entity[b.start],d=a.entity[b.end],a.Base.call(this,b),this.start=b.start,this.end=b.end,this.springConstant=b.springConstant||1e3,this.damperConstant=b.damperConstant||100,a.xt(b.restLength)?this.restLength=b.restLength:(e=a.workphys.v1.set(d.place),e.vectorSubtract(c.place),this.restLength=e.getMagnitude()),this.currentLength=b.currentLength||this.restLength,this.force=a.makeVector(),this.work.force=a.makeVector(),a.spring[this.name]=this,a.pushUnique(a.springnames,this.name),this):!1},a.Spring.prototype=Object.create(a.Base.prototype),a.Spring.prototype.type="Spring",a.Spring.prototype.classname="springnames",a.d.Spring={start:"",end:"",springConstant:1e3,damperConstant:100,restLength:1,currentLength:1,force:{x:0,y:0,z:0}},a.mergeInto(a.d.Spring,a.d.Scrawl),a.Spring.prototype.update=function(){var b,c,d,e;return b=a.workphys.v1.set(a.entity[this.end].velocity).vectorSubtract(a.entity[this.start].velocity),c=a.workphys.v2.set(a.entity[this.end].place).vectorSubtract(a.entity[this.start].place),d=a.workphys.v3.set(c).normalize(),e=a.workphys.v4.set(d),this.force.set(d.scalarMultiply(this.springConstant*(c.getMagnitude()-this.restLength)).vectorAdd(b.vectorMultiply(e).scalarMultiply(this.damperConstant).vectorMultiply(e))),this},a.Spring.prototype.kill=function(){return a.removeItem(a.entity[this.start].springs,this.name),a.removeItem(a.entity[this.end].springs,this.name),delete a.spring[this.name],a.removeItem(a.springnames,this.name),!0},a.pushUnique(a.sectionlist,"force"),a.pushUnique(a.nameslist,"forcenames"),a.Force=function(b){return a.Base.call(this,b),b=a.safeObject(b),this.fn=b.fn||function(){},a.force[this.name]=this,a.pushUnique(a.forcenames,this.name),this},a.Force.prototype=Object.create(a.Base.prototype),a.Force.prototype.type="Force",a.Force.prototype.classname="forcenames",a.d.Force={fn:function(){}},a.mergeInto(a.d.Force,a.d.Scrawl),a.Force.prototype.run=function(a){return this.fn(a)},a.Force.prototype.kill=function(){return delete a.force[this.name],a.removeItem(a.forcenames,this.name),!0},a}(scrawl);