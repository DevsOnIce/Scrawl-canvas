/*! scrawl 2014-04-05 */
"use strict";var scrawl=function(a){return a.physics={gravity:9.8,airDensity:1.23,deltaTime:0},a.updateSprings=function(b){if(a.springnames.length>0){var c=[];b=a.isa(b,"arr")?b:a.springnames;for(var d=0,e=b.length;e>d;d++)c.push(a.isa(b[d],"obj")?b[d]:a.isa(b[d],"str")?a.spring[b[d]]:!1);for(var d=0,e=c.length;e>d;d++)c[d]&&c[d].update();return!0}return!1},a.physicsInit=function(){a.newForce({name:"gravity",fn:function(b){b.load.vectorAdd({y:b.mass*a.physics.gravity})}}),a.newForce({name:"drag",fn:function(b){var c=b.velocity.getConjugate();c.normalize();var d=b.velocity.getMagnitude(),e=.5*a.physics.airDensity*d*d*b.get("area")*b.get("drag");c.scalarMultiply(e),b.load.vectorAdd(c)}})},a.newParticle=function(b){return new a.Particle(b)},a.newSpring=function(b){return new a.Spring(b)},a.newForce=function(b){return new a.Force(b)},a.Particle=function(b){return a.Base.call(this,b),b=a.safeObject(b),this.place=a.newVector(),this.velocity=a.newVector(),this.set(b),this.priorPlace=this.place.getVector(),this.engine=b.engine||"euler",this.userVar=b.userVar||{},this.mobile=a.isa(b.mobile,"bool")?b.mobile:!0,this.forces=b.forces||[],this.springs=b.springs||[],this.mass=b.mass||a.d.Particle.mass,this.elasticity=b.elasticity||a.d.Particle.elasticity,this.radius=b.radius||a.d.Particle.radius,(b.radius||b.area)&&(this.area=b.area||2*Math.PI*this.get("radius")*this.get("radius")||a.d.Particle.area),this.load=a.newVector(),a.sprite[this.name]=this,a.pushUnique(a.spritenames,this.name),this.group=a.Sprite.prototype.getGroup.call(this,b),a.group[this.group].addSpritesToGroup(this.name),this},a.Particle.prototype=Object.create(a.Base.prototype),a.Particle.prototype.type="Particle",a.Particle.prototype.classname="spritenames",a.Particle.prototype.order=0,a.d.Particle={group:"",order:0,mobile:!0,mass:1,radius:.1,area:.03,drag:.42,elasticity:1,userVar:{},place:{x:0,y:0,z:0},velocity:{x:0,y:0,z:0},engine:"euler",forces:[],springs:[],load:a.newVector()},a.mergeInto(a.d.Particle,a.d.Scrawl),a.Particle.prototype.set=function(b){b=a.safeObject(b);var c;return a.Base.prototype.set.call(this,b),this.place.type&&"Vector"===this.place.type||(this.place=a.newVector(b.place||this.place)),a.xto([b.start,b.startX,b.startY])&&(c=a.isa(b.start,"obj")?b.start:{},this.place.x=a.xt(b.startX)?b.startX:a.xt(c.x)?c.x:this.place.x,this.place.y=a.xt(b.startY)?b.startY:a.xt(c.y)?c.y:this.place.y),this.velocity.type&&"Vector"===this.velocity.type||(this.velocity=a.newVector(b.velocity||this.velocity)),a.xto([b.delta,b.deltaX,b.deltaY])&&(c=a.isa(b.delta,"obj")?b.delta:{},this.velocity.x=a.xt(b.deltaX)?b.deltaX:a.xt(c.x)?c.x:this.velocity.x,this.velocity.y=a.xt(b.deltaY)?b.deltaY:a.xt(c.y)?c.y:this.velocity.y),this},a.Particle.prototype.clone=function(b){var c=a.Base.prototype.clone.call(this,b);c.place=a.newVector(c.place),c.velocity=a.newVector(c.velocity),c.forces=[];for(var d=0,e=this.forces.length;e>d;d++)c.forces.push(this.forces[d]);return c},a.Particle.prototype.addForce=function(b){return a.xt(b)&&this.forces.push(b),this},a.Particle.prototype.revert=function(){return this.place=this.priorPlace.getVector(),this},a.Particle.prototype.stamp=function(){if(this.mobile)switch(this.calculateLoads(),this.engine){case"improvedEuler":this.updateImprovedEuler();break;case"rungeKutter":this.updateRungeKutter();break;default:this.updateEuler()}return this},a.Particle.prototype.forceStamp=function(){return this.stamp()},a.Particle.prototype.update=function(){return this.stamp()},a.Particle.prototype.calculateLoads=function(){this.load=a.newVector();for(var b=0,c=this.forces.length;c>b;b++)a.isa(this.forces[b],"str")&&a.contains(a.forcenames,this.forces[b])?a.force[this.forces[b]].run(this):this.forces[b](this);for(var b=0,c=this.springs.length;c>b;b++)a.spring[this.springs[b]].start===this.name?this.load.vectorAdd(a.spring[this.springs[b]].force):a.spring[this.springs[b]].end===this.name&&this.load.vectorSubtract(a.spring[this.springs[b]].force);return this},a.Particle.prototype.updateEuler=function(){return this.velocity.vectorAdd(this.load.getScalarDivide(this.mass).scalarMultiply(a.physics.deltaTime)),this.priorPlace=this.place.getVector(),this.place.vectorAdd(this.velocity.getScalarMultiply(a.physics.deltaTime)),this},a.Particle.prototype.updateImprovedEuler=function(){var b=this.load.getScalarDivide(this.mass).scalarMultiply(a.physics.deltaTime),c=this.load.getVectorAdd(b).scalarDivide(this.mass).scalarMultiply(a.physics.deltaTime),d=b.getVectorAdd(c).scalarDivide(2);return this.velocity.vectorAdd(d),this.priorPlace=this.place.getVector(),this.place.vectorAdd(this.velocity.getScalarMultiply(a.physics.deltaTime)),this},a.Particle.prototype.updateRungeKutter=function(){var b=this.load.getScalarDivide(this.mass).scalarMultiply(a.physics.deltaTime).scalarDivide(2),c=this.load.getVectorAdd(b).scalarDivide(this.mass).scalarMultiply(a.physics.deltaTime).scalarDivide(2),d=this.load.getVectorAdd(c).scalarDivide(this.mass).scalarMultiply(a.physics.deltaTime),e=this.load.getVectorAdd(d).scalarDivide(this.mass).scalarMultiply(a.physics.deltaTime);c.scalarMultiply(2),d.scalarMultiply(2);var f=b.getVectorAdd(c).vectorAdd(d).vectorAdd(e).scalarDivide(6);return this.velocity.vectorAdd(f),this.priorPlace=this.place.getVector(),this.place.vectorAdd(this.velocity.getScalarMultiply(a.physics.deltaTime)),this},a.Particle.prototype.linearCollide=function(a){var b=this.place.getVectorSubtract(a.place),c=b.getNormal(),d=this.velocity.getVectorSubtract(a.velocity),e=d.getDotProduct(c);e=-e*(1+(this.elasticity+a.elasticity)/2),e/=1/this.mass+1/a.mass;var f=c.getScalarMultiply(e);return this.velocity.vectorAdd(f.scalarDivide(this.mass)),a.velocity.vectorAdd(f.scalarDivide(a.mass).reverse()),this},a.Particle.prototype.addSpring=function(b){var c=!1,d=!1;if(a.isa(b,"str")&&a.contains(a.spritenames,b)){d=b;var e={};e.start=this.name,e.end=b,c=a.newSpring(e)}else b=a.isa(b,"obj")?b:{},d=b.end||!1,d&&a.contains(a.spritenames,d)&&(b.start=this.name,c=a.newSpring(b));return c&&(a.pushUnique(this.springs,c.name),a.pushUnique(a.sprite[d].springs,c.name)),this},a.Particle.prototype.removeSprings=function(){for(var b=[],c=0,d=this.springs.length;d>c;c++)b.push(this.springs[c]);for(var c=0,d=b.length;d>c;c++)a.spring[b].kill();return this},a.Particle.prototype.removeSpringsTo=function(b){if(a.xt(b)&&a.contains(a.spritenames,b)){for(var c,d=[],e=0,f=this.springs.length;f>e;e++)c=a.spring[this.springs[e]],(c.start===this.name||c.end===this.name)&&d.push(this.springs[e]);for(var e=0,f=d.length;f>e;e++)a.spring[d].kill()}return this},a.Particle.prototype.pickupSprite=function(){return this},a.Particle.prototype.dropSprite=function(){return this},a.Particle.prototype.updateStart=function(){return this},a.pushUnique(a.sectionlist,"spring"),a.pushUnique(a.nameslist,"springnames"),a.Spring=function(b){if(b=a.safeObject(b),a.xta([b.start,b.end])){var c=a.sprite[b.start],d=a.sprite[b.end];if(a.Base.call(this,b),this.start=b.start,this.end=b.end,this.springConstant=b.springConstant||1e3,this.damperConstant=b.damperConstant||100,a.xt(b.restLength))this.restLength=b.restLength;else{var e=d.place.getVector();e.vectorSubtract(c.place),this.restLength=e.getMagnitude()}return this.currentLength=b.currentLength||this.restLength,this.force=a.newVector(),a.spring[this.name]=this,a.pushUnique(a.springnames,this.name),this}return!1},a.Spring.prototype=Object.create(a.Base.prototype),a.Spring.prototype.type="Spring",a.Spring.prototype.classname="springnames",a.d.Spring={start:"",end:"",springConstant:1e3,damperConstant:100,restLength:1,currentLength:1,force:{x:0,y:0,z:0}},a.mergeInto(a.d.Spring,a.d.Scrawl),a.Spring.prototype.update=function(){var b=a.sprite[this.end].velocity.getVectorSubtract(a.sprite[this.start].velocity),c=a.sprite[this.end].place.getVectorSubtract(a.sprite[this.start].place),d=c.getNormal();return this.force=d.getScalarMultiply(this.springConstant*(c.getMagnitude()-this.restLength)).vectorAdd(b.vectorMultiply(d).scalarMultiply(this.damperConstant).vectorMultiply(d)),this},a.Spring.prototype.kill=function(){return a.removeItem(a.sprite[this.start].springs,this.name),a.removeItem(a.sprite[this.end].springs,this.name),delete a.spring[this.name],a.removeItem(a.springnames,this.name),!0},a.pushUnique(a.sectionlist,"force"),a.pushUnique(a.nameslist,"forcenames"),a.Force=function(b){return a.Base.call(this,b),b=a.safeObject(b),this.fn=b.fn||function(){},a.force[this.name]=this,a.pushUnique(a.forcenames,this.name),this},a.Force.prototype=Object.create(a.Base.prototype),a.Force.prototype.type="Force",a.Force.prototype.classname="forcenames",a.d.Force={fn:function(){}},a.mergeInto(a.d.Force,a.d.Scrawl),a.Force.prototype.run=function(a){return this.fn(a)},a.Force.prototype.kill=function(){return delete a.force[this.name],a.removeItem(a.forcenames,this.name),!0},a}(scrawl);